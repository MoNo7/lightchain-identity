<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        body { font-family: monospace; background: transparent; color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .workspace { flex: 1; display: flex; flex-direction: column; gap: 20px; padding: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 12px; }
        .prompt-input { width: 100%; background: #111; border: 1px solid #444; border-radius: 10px; padding: 18px; color: white; font-size: 1rem; box-sizing: border-box; outline: none; }
        .prompt-input:focus { border-color: #00ff80; }
        .controls-row { display: flex; gap: 12px; width: 100%; }
        select { flex: 1; background: #111; color: #00ff80; border: 1px solid #444; border-radius: 8px; padding: 10px; font-weight: bold; cursor: pointer; }
        .btn-gen { height: 50px; padding: 0 40px; background: #00ff80; color: black; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; }
        .output-view { flex: 1; background: #000; border: 1px solid #333; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .output-img { max-width: 95%; max-height: 95%; display: none; object-fit: contain; }
        .status-txt { color: #666; font-size: 0.9rem; text-align: center; }
        .history-sidebar { width: 260px; border-left: 1px solid #333; background: rgba(0,0,0,0.2); padding: 20px; display: flex; flex-direction: column; }
        #history-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; overflow-y: auto; }
        .gallery-item { aspect-ratio: 1/1; background: #111; border: 1px solid #333; border-radius: 6px; cursor: pointer; overflow: hidden; position: relative; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; transition: 0.3s; }
        .gallery-item:hover img { opacity: 1; }
    </style>
</head>
<body>

<div class="workspace">
    <div class="input-group">
        <input type="text" id="prompt-input" class="prompt-input" placeholder="Initiate AIVM Prompt...">
        <div class="controls-row">
            <select id="model-select">
                <option value="0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef">SDXL-Turbo (Default)</option>
                <option value="0x8888888888888888888888888888888888888888888888888888888888888888">Flux.1-Lightning</option>
                <option value="0x9999999999999999999999999999999999999999999999999999999999999999">Stable Diffusion 3</option>
            </select>
            <button id="gen-button" class="btn-gen" onclick="generate()">GENERATE</button>
        </div>
    </div>
    <div class="output-view">
        <p id="status-label" class="status-txt">Awaiting Cluster Input...</p>
        <img id="result-img" class="output-img">
    </div>
</div>

<div class="history-sidebar">
    <h3 style="font-size: 0.6rem; color: #00ff80; letter-spacing: 2px; margin-bottom: 15px;">ON-CHAIN REVEALS</h3>
    <div id="history-grid"></div>
</div>

<script>
const CONFIG = { AIVM_ADDR: "0xbcA38515887Dc3Ca163398C0Ef7bF02dd156D8FB" };
const ABI = [
    "function generateArt(string prompt, bytes32 modelDigest) public payable",
    "event ArtGenerated(address indexed user, string prompt, bytes32 modelDigest, uint256 fee)"
];

async function updatePill(load, status) {
    window.parent.postMessage({ type: 'AIVM_SYNC', load: load, status: status }, '*');
}

async function generate() {
    const prompt = document.getElementById('prompt-input').value;
    const model = document.getElementById('model-select').value;
    const statusLabel = document.getElementById('status-label');
    const imgEl = document.getElementById('result-img');

    if (!prompt) return;
// STEP 1: START SIGNING
    window.parent.postMessage({ type: 'AIVM_SYNC', load: 15, status: 'signing' }, '*');
    
    try {
        updatePill(25, 'signing');
        statusLabel.innerText = "Check Wallet for Signature...";
        
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const contract = new ethers.Contract(CONFIG.AIVM_ADDR, ABI, signer);

        const tx = await contract.generateArt(prompt, model, { 
            value: ethers.parseEther("0.1"),
            gasLimit: 500000 
        });
        window.parent.postMessage({ type: 'AIVM_SYNC', load: 55, status: 'mining' }, '*');
        await tx.wait();

        // STEP 3: SUCCESS & SYNC
        window.parent.postMessage({ type: 'AIVM_SYNC', load: 100, status: 'success' }, '*');
        
        updatePill(65, 'mining');
        statusLabel.innerText = "Mining Inference on Lightchain...";
        await tx.wait();
        // Render Reveal
        revealResult(prompt);
        updatePill(100, 'success');
        statusLabel.style.display = "none";
        imgEl.src = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true&seed=${Date.now()}`;
        imgEl.style.display = "block";
        
// Return to IDLE after 5 seconds
        setTimeout(() => {
            window.parent.postMessage({ type: 'AIVM_SYNC', load: 0, status: 'idle' }, '*');
            initHistory(); 
        }, 5000);
    } catch (e) {
        updatePill(0, 'error');
        statusLabel.innerText = "Inference Failed: " + (e.reason || "Check Balance");
        window.parent.postMessage({ type: 'AIVM_SYNC', load: 0, status: 'error' }, '*');
        console.error(e);
    }
}

async function initHistory() {
    try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send("eth_accounts", []);
        if (!accounts[0]) return;

        const contract = new ethers.Contract(CONFIG.AIVM_ADDR, ABI, provider);
        const filter = contract.filters.ArtGenerated(accounts[0]);
        const events = await contract.queryFilter(filter, -40000); 

        
        const historyHtml = events.reverse().map(e => {
            const p = e.args.prompt;
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?nologo=true&seed=${e.blockNumber}`;
            return `<div class="gallery-item" onclick="loadHist('${p}','${url}')"><img src="${url}"></div>`;
        }).join('');

        document.getElementById('history-grid').innerHTML = historyHtml;
        const grid = document.getElementById('history-grid');
        grid.innerHTML = events.reverse().map(e => {
            const p = e.args.prompt;
            const seed = e.blockNumber;
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?nologo=true&seed=${seed}`;
            return `<div class="gallery-item" onclick="loadHist('${p}','${url}')"><img src="${url}"></div>`;
        }).join('');
    } catch (e) { console.error("Gallery sync failed", e); }
}

function loadHist(p, url) {
    document.getElementById('prompt-input').value = p;
    document.getElementById('result-img').src = url;
    document.getElementById('result-img').style.display = "block";
    document.getElementById('status-label').style.display = "none";
}

window.addEventListener('load', () => { if(window.ethereum) initHistory(); });
</script>
</body>
</html>
