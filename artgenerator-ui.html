<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AIVM Generator | Lightchain AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #5865f2; --secondary: #00ff80; --bg: #0f1016; --card: #1a1b26; --border: #2d2f45; --text: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: transparent; color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        
        /* Main Workspace */
        .workspace { flex: 1; display: flex; flex-direction: column; gap: 15px; padding: 20px; height: 100%; }
        .input-group { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; padding: 8px; }
        .prompt-input { flex: 1; background: transparent; border: none; color: white; padding: 12px; outline: none; font-size: 1rem; }
        .btn-gen { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .output-view { flex: 1; background: #000; border: 1px solid var(--border); border-radius: 12px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .output-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        .status-txt { color: #94a3b8; text-align: center; font-size: 1.1rem; }

        /* Gallery Sidebar */
        .history-sidebar { width: 300px; background: rgba(0,0,0,0.4); border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .history-header { font-size: 0.75rem; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* Gallery Grid */
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .gallery-item { aspect-ratio: 1/1; border-radius: 6px; overflow: hidden; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; background: #08090f; position: relative; }
        .gallery-item:hover { border-color: var(--secondary); transform: scale(1.05); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-item::after { content: "RELOAD"; position: absolute; inset: 0; background: rgba(0,255,128,0.2); display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 800; color: var(--secondary); opacity: 0; transition: 0.2s; }
        .gallery-item:hover::after { opacity: 1; }

        .mint-btn { position: absolute; bottom: 20px; right: 20px; background: var(--secondary); color: black; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 800; cursor: pointer; display: none; }
    </style>
</head>
<body>
    <div class="workspace">
        <div class="input-group">
            <input type="text" id="prompt-input" class="prompt-input" placeholder="A futuristic cyberpunk city in neon lights...">
            <button class="btn-gen" onclick="generate()">GENERATE</button>
        </div>
        <div class="output-view">
            <p id="status" class="status-txt">Ready for Inference...</p>
            <img id="result-img" class="output-img">
            <button id="mint-btn" class="mint-btn" onclick="mintNFT()">MINT AS NFT</button>
        </div>
    </div>

    <div class="history-sidebar">
        <div class="history-header">Recent Inferences (10)</div>
        <div id="history-grid" class="gallery-grid"></div>
    </div>

    <script>
const CONFIG = { 
    AIVM_ADDR: "0xbcA38515887Dc3Ca163398C0Ef7bF02dd156D8FB",
    SBT_ADDR: "0xd71462F0002Ee9373fCe05B568583Ed13e75f600" 
};
        const ABI = [
            "function generateArt(string) external payable",
            "event ArtGenerated(address indexed user, string prompt, string timestamp)" 
        ];
        let history = JSON.parse(localStorage.getItem('ai_history') || '[]');
      
// Replace the initHistory function in artgenerator-ui.html
async function initHistory() {
    try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        
        // TARGET: AIArtStudio for Inference History (NOT the Identity SBT)
        const contract = new ethers.Contract(CONFIG.AIVM_ADDR, [
            "event ArtGenerated(address indexed user, string prompt, bytes32 modelDigest, uint256 fee)"
        ], provider);
        
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        const user = accounts[0];

        window.parent.postMessage({ type: "LCAI_STATUS", message: "Scanning AIVM On-Chain Gallery..." }, "*");

        // Scan for ArtGenerated events specifically from your wallet
        const filter = contract.filters.ArtGenerated(user);
        const events = await contract.queryFilter(filter, -10000); 

        // Map events to the image worker URL
        history = events.map(e => ({
            prompt: e.args.prompt,
            url: `https://image.pollinations.ai/prompt/${encodeURIComponent(e.args.prompt)}?nologo=true`
        })).reverse().slice(0, 10);

        renderHistory();
        
        const statusMsg = history.length > 0 
            ? `Gallery Synced: ${history.length} inferences found.` 
            : "No AIVM inferences found on-chain yet.";
            
        window.parent.postMessage({ type: "LCAI_STATUS", message: statusMsg }, "*");
    } catch (e) {
        console.error("Gallery Sync Failed:", e);
        window.parent.postMessage({ type: "LCAI_STATUS", message: "Gallery Sync Error: Check ABI Mismatch" }, "*");
    }
}
        
        function updateHistory(prompt, url) {
            history.unshift({ prompt, url });
            if(history.length > 10) history.pop();
            localStorage.setItem('ai_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const grid = document.getElementById('history-grid');
            if (!history.length) {
                grid.innerHTML = '<div style="color:var(--text-dim); font-size:0.6rem;">No on-chain history found.</div>';
                return;
            }
            grid.innerHTML = history.map((item, i) => `
                <div class="gallery-item" onclick="loadHistory(${i})">
                    <img src="${item.url}" loading="lazy">
                </div>
            `).join('');
        }

        function loadHistory(i) {
            const item = history[i];
            const img = document.getElementById('result-img');
            img.src = item.url;
            img.style.display = 'block';
            document.getElementById('status').style.display = 'none';
            document.getElementById('mint-btn').style.display = 'block';
            window.parent.postMessage({ type: "LCAI_STATUS", message: `Reloading Inference: "${item.prompt}"` }, "*");
        }

        async function generate() {
            const prompt = document.getElementById('prompt-input').value;
            if(!prompt || !window.ethereum) return;

            window.parent.postMessage({ type: "LCAI_STATUS", message: `Inference Initiated: "${prompt}"` }, "*");
            document.getElementById('status').innerText = "Processing...";
            document.getElementById('result-img').style.display = 'none';
            document.getElementById('mint-btn').style.display = 'none';

            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const contract = new ethers.Contract(CONFIG.AIVM_ADDR, ["function generateArt(string) external payable"], signer);
                
                const tx = await contract.generateArt(prompt, { value: ethers.parseEther("1.0") });
                window.parent.postMessage({ type: "LCAI_STATUS", message: "Transaction Anchored. Awaiting Reveal..." }, "*");
                await tx.wait();

                setTimeout(() => {
                    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true`;
                    const img = document.getElementById('result-img');
                    img.src = url;
                    img.onload = () => {
                        img.style.display = 'block';
                        document.getElementById('status').style.display = 'none';
                        document.getElementById('mint-btn').style.display = 'block';
                        window.parent.postMessage({ type: "LCAI_GEN_SUCCESS" }, "*");
                        updateHistory(prompt, url);
                    };
                }, 1500);
            } catch (e) {
                window.parent.postMessage({ type: "LCAI_STATUS", message: "AIVM Error: Inference Aborted" }, "*");
            }
        }
window.addEventListener('load', () => {
    if (window.ethereum) initHistory();
});
        async function mintNFT() {
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const contract = new ethers.Contract(CONFIG.SBT_ADDR, ["function mintIdentity() external"], signer);
                alert("Anchoring current output to LCAI Identity Registry...");
                const tx = await contract.mintIdentity();
                await tx.wait();
                alert("Success! Art anchored as soulbound creation.");
            } catch (e) { alert("Minting Failed: Check gas or identity status"); }
        }
        renderHistory();
    </script>
</body>
</html>
