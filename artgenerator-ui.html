<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AIVM Generator | Lightchain AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #5865f2; --secondary: #00ff80; --bg: #0f1016; --card: #1a1b26; --border: #2d2f45; --text: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: transparent; color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        
        /* Main Workspace */
        .workspace { flex: 1; display: flex; flex-direction: column; gap: 15px; padding: 20px; height: 100%; }
        .input-group { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; padding: 8px; }
        .prompt-input { flex: 1; background: transparent; border: none; color: white; padding: 12px; outline: none; font-size: 1rem; }
        .btn-gen { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .output-view { flex: 1; background: #000; border: 1px solid var(--border); border-radius: 12px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .output-img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        .status-txt { color: #94a3b8; text-align: center; font-size: 1.1rem; }

        /* Gallery Sidebar */
        .history-sidebar { width: 300px; background: rgba(0,0,0,0.4); border-left: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .history-header { font-size: 0.75rem; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* Gallery Grid */
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .gallery-item { aspect-ratio: 1/1; border-radius: 6px; overflow: hidden; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; background: #08090f; position: relative; }
        .gallery-item:hover { border-color: var(--secondary); transform: scale(1.05); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-item::after { content: "RELOAD"; position: absolute; inset: 0; background: rgba(0,255,128,0.2); display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 800; color: var(--secondary); opacity: 0; transition: 0.2s; }
        .gallery-item:hover::after { opacity: 1; }

        .mint-btn { position: absolute; bottom: 20px; right: 20px; background: var(--secondary); color: black; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 800; cursor: pointer; display: none; }
    </style>
</head>
<body>
<div class="workspace" style="flex: 1; display: flex; flex-direction: column; gap: 20px; padding: 20px;">
    <div class="input-group" style="display: flex; flex-direction: column; gap: 12px;">
        <input type="text" id="prompt-input" class="prompt-input" 
               style="width: 100%; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 18px; font-size: 1rem; color: white;" 
               placeholder="Enter AIVM Prompt...">
        
        <div style="display: flex; gap: 12px; width: 100%;">
            <select id="model-select" style="flex: 1; background: var(--card); color: var(--secondary); border: 1px solid var(--border); border-radius: 8px; padding: 0 15px; height: 50px; font-weight: 600;">
                <option value="0x123456...7890">SDXL-Turbo (LCAI Default)</option>
                <option value="0x888888...8888">Flux.1-Lightning</option>
                <option value="0x999999...9999">Stable Diffusion 3</option>
            </select>
            <button class="btn-gen" onclick="generate()" style="height: 50px; padding: 0 40px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; letter-spacing: 1px;">GENERATE</button>
        </div>
    </div>
    
    <div class="output-view" style="flex: 1; background: #000; border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
        <p id="status" class="status-txt" style="color: var(--text-dim);">Awaiting AIVM Instruction...</p>
        <img id="result-img" class="output-img" style="max-width: 100%; max-height: 100%; display: none;">
    </div>
</div>

<div class="history-sidebar" style="width: 260px; border-left: 1px solid var(--border); background: rgba(0,0,0,0.3); padding: 20px; display: flex; flex-direction: column;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="font-size: 0.7rem; color: var(--primary); letter-spacing: 1.5px; font-weight: 900;">ON-CHAIN REVEALS</h3>
        <button onclick="initHistory()" style="background: var(--border); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;">SYNC â†»</button>
    </div>
    <div id="history-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; overflow-y: auto;">
        </div>
</div>
    <select id="model-select" style="background: var(--bg); color: var(--secondary); border: 1px solid var(--border); border-radius: 4px; padding: 0 10px; margin-right: 8px; font-size: 0.7rem; cursor: pointer;">
        <option value="0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef">SDXL-Turbo (LCAI Default)</option>
        <option value="0x8888888888888888888888888888888888888888888888888888888888888888">Flux.1-Lightning</option>
        <option value="0x9999999999999999999999999999999999999999999999999999999999999999">Stable Diffusion 3</option>
    </select>
    <script>
const CONFIG = { 
    AIVM_ADDR: "0xbcA38515887Dc3Ca163398C0Ef7bF02dd156D8FB", 
    SBT_ADDR: "0xd71462F0002Ee9373fCe05B568583Ed13e75f600" 
};
        const ABI = [
            "function generateArt(string) external payable",
            "event ArtGenerated(address indexed user, string prompt, string timestamp)" 
        ];
        let history = JSON.parse(localStorage.getItem('ai_history') || '[]');
      
        async function initHistory() {
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const contract = new ethers.Contract(CONFIG.AIVM_ADDR, [
                    "event ArtGenerated(address indexed user, string prompt, bytes32 modelDigest, uint256 fee)"
                ], provider);
                
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                const user = accounts[0];
        
                // Scanning 50,000 blocks to ensure we hit all 16 inferences
                const filter = contract.filters.ArtGenerated(user);
                const events = await contract.queryFilter(filter, -50000); 
        
                history = events.map(e => {
                    // FIX: Ensure prompt is a string and not empty
                    const p = (e.args.prompt && e.args.prompt.length > 0) ? e.args.prompt : "AIVM Art";
                    return {
                        prompt: p,
                        digest: e.args.modelDigest.slice(0, 8),
                        url: `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?nologo=true&seed=${e.blockNumber}`
                    };
                }).reverse(); // Show all, newest first
        
                renderHistory();
                window.parent.postMessage({ type: "LCAI_STATUS", message: `Gallery Refreshed: ${history.length} Inferences Found.` }, "*");
            } catch (e) { console.error("History Sync Failed", e); }
        }
        function updateHistory(prompt, url) {
            history.unshift({ prompt, url });
            if(history.length > 10) history.pop();
            localStorage.setItem('ai_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const grid = document.getElementById('history-grid');
            grid.innerHTML = history.map((item, i) => `
                <div class="gallery-item" onclick="loadHistory(${i})" style="position:relative; aspect-ratio:1/1; background:#080808; border:1px solid var(--border); border-radius:8px; overflow:hidden; cursor:pointer;">
                    <img src="${item.url}" style="width:100%; height:100%; object-fit:cover;" 
                         onerror="this.src='https://via.placeholder.com/150/000000/00FF80?text=REVEALING...'">
                    <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.7); color:var(--secondary); font-size:8px; text-align:center; padding:3px 0; font-family:monospace;">
                        ${item.digest}
                    </div>
                </div>
            `).join('');
        }

        function loadHistory(i) {
            const item = history[i];
            const img = document.getElementById('result-img');
            img.src = item.url;
            img.style.display = 'block';
            document.getElementById('status').style.display = 'none';
            document.getElementById('mint-btn').style.display = 'block';
            window.parent.postMessage({ type: "LCAI_STATUS", message: `Reloading Inference: "${item.prompt}"` }, "*");
        }

        async function generate() {
            const prompt = document.getElementById('prompt-input').value;
            if(!prompt || !window.ethereum) return;

            window.parent.postMessage({ type: "LCAI_STATUS", message: `Inference Initiated: "${prompt}"` }, "*");
            document.getElementById('status').innerText = "Processing...";
            document.getElementById('result-img').style.display = 'none';
            document.getElementById('mint-btn').style.display = 'none';

            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const contract = new ethers.Contract(CONFIG.AIVM_ADDR, ["function generateArt(string) external payable"], signer);
                
                const tx = await contract.generateArt(prompt, { value: ethers.parseEther("1.0") });
                window.parent.postMessage({ type: "LCAI_STATUS", message: "Transaction Anchored. Awaiting Reveal..." }, "*");
                await tx.wait();

                setTimeout(() => {
                    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true`;
                    const img = document.getElementById('result-img');
                    img.src = url;
                    img.onload = () => {
                        img.style.display = 'block';
                        document.getElementById('status').style.display = 'none';
                        document.getElementById('mint-btn').style.display = 'block';
                        window.parent.postMessage({ type: "LCAI_GEN_SUCCESS" }, "*");
                        updateHistory(prompt, url);
                    };
                }, 1500);
            } catch (e) {
                window.parent.postMessage({ type: "LCAI_STATUS", message: "AIVM Error: Inference Aborted" }, "*");
            }
        }
window.addEventListener('load', () => {
    if (window.ethereum) initHistory();
});
        async function mintNFT() {
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const contract = new ethers.Contract(CONFIG.SBT_ADDR, ["function mintIdentity() external"], signer);
                alert("Anchoring current output to LCAI Identity Registry...");
                const tx = await contract.mintIdentity();
                await tx.wait();
                alert("Success! Art anchored as soulbound creation.");
            } catch (e) { alert("Minting Failed: Check gas or identity status"); }
        }
        renderHistory();
    </script>
</body>
</html>
