<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AIVM Generator | Lightchain AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #5865f2; --secondary: #00ff80; --bg: #0f1016; --card: #1a1b26; --border: #2d2f45; --text: #ffffff; }
        body { background: transparent; color: var(--text); padding: 0; height: 100vh; display: flex; overflow: hidden; }
        .workspace { flex: 1; display: flex; flex-direction: column; gap: 15px; padding: 20px; }
        .history-sidebar { width: 220px; background: rgba(0,0,0,0.3); border-left: 1px solid var(--border); padding: 15px; overflow-y: auto; }
        .input-group { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; padding: 8px; }
        .prompt-input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; }
        .output-view { flex: 1; background: #000; border: 1px solid var(--border); border-radius: 12px; position: relative; display: flex; align-items: center; justify-content: center; }
        .output-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .history-item { font-size: 0.7rem; padding: 8px; border-bottom: 1px solid var(--border); cursor: pointer; color: #94a3b8; }
        .history-item:hover { color: var(--secondary); }
        .mint-btn { position: absolute; bottom: 20px; right: 20px; background: var(--secondary); color: black; border: none; padding: 8px 15px; border-radius: 5px; font-weight: 800; display: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="workspace">
        <div class="input-group">
            <input type="text" id="prompt-input" class="prompt-input" placeholder="Enter AIVM Instruction...">
            <button class="btn-gen" style="background:var(--primary); color:white; border:none; border-radius:6px; padding:0 20px;" onclick="generate()">GENERATE</button>
        </div>
        <div class="output-view">
            <p id="status">Ready for Inference...</p>
            <img id="result-img" class="output-img" style="display:none">
            <button id="mint-btn" class="mint-btn" onclick="mintNFT()">MINT AS NFT</button>
        </div>
    </div>
    <div class="history-sidebar">
        <div style="font-size:0.7rem; font-weight:800; margin-bottom:10px; color:var(--primary)">RECENT INFERENCE (LAST 10)</div>
        <div id="history-list"></div>
    </div>

    <script>
        let currentPrompt = "";
        let history = JSON.parse(localStorage.getItem('ai_history') || '[]');

        function updateHistory(prompt, url) {
            history.unshift({ prompt, url });
            if(history.length > 10) history.pop();
            localStorage.setItem('ai_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = history.map((item, i) => `
                <div class="history-item" onclick="loadHistory(${i})">${item.prompt.slice(0,30)}...</div>
            `).join('');
        }

        function loadHistory(i) {
            const item = history[i];
            const img = document.getElementById('result-img');
            img.src = item.url;
            img.style.display = 'block';
            document.getElementById('status').style.display = 'none';
            document.getElementById('mint-btn').style.display = 'block';
        }

        async function generate() {
            const prompt = document.getElementById('prompt-input').value;
            if(!prompt) return;
            document.getElementById('status').innerText = "Anchoring to LCAI AIVM...";
            
            // Simulation of AIVM Worker Reveal
            setTimeout(() => {
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true`;
                const img = document.getElementById('result-img');
                img.src = url;
                img.onload = () => {
                    img.style.display = 'block';
                    document.getElementById('status').style.display = 'none';
                    document.getElementById('mint-btn').style.display = 'block';
                    updateHistory(prompt, url);
                };
            }, 2000);
        }

        async function mintNFT() {
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                // Placeholder: Calling mint function on your Identity contract
                const sbtContract = new ethers.Contract("0xd71462F0002Ee9373fCe05B568583Ed13e75f600", ["function mintIdentity() external"], signer);
                
                alert("Confirming NFT Mint for current AIVM output...");
                const tx = await sbtContract.mintIdentity();
                await tx.wait();
                alert("Success! Art anchored to LCAI Identity Registry.");
            } catch (e) { alert("Minting failed: Check gas or identity status"); }
        }
        renderHistory();
    </script>
</body>
</html>
