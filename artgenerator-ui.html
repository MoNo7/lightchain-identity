<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', monospace; background: transparent; color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .main { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        .prompt-area { width: 100%; background: #05070a; border: 1px solid #1e2633; border-radius: 8px; padding: 15px; color: white; box-sizing: border-box; resize: none; font-family: monospace; font-size: 0.8rem; }
        .controls { display: flex; gap: 10px; align-items: center; }
        select { flex: 1; background: #05070a; color: #0070ff; border: 1px solid #1e2633; border-radius: 6px; padding: 10px; font-family: monospace; cursor: pointer; }
        .btn { background: #0070ff; color: white; border: none; padding: 10px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #0056cc; }
        .btn:disabled { background: #1a202c; cursor: not-allowed; }
        .canvas { flex: 1; background: #000; border: 1px solid #1e2633; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        #img-display { max-width: 95%; max-height: 95%; display: none; border-radius: 8px; box-shadow: 0 0 30px rgba(0,112,255,0.15); border: 1px solid #333; }
        .loader { border: 4px solid #1a202c; border-top: 4px solid #0070ff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-overlay { color: #4e5d75; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="main">
        <textarea id="prompt-input" class="prompt-area" rows="3" placeholder="Describe the neural vision..."></textarea>
        <div class="controls">
            <select id="model-digest">
                <option value="0x2bf0539500000000000000000000000000000000000000000000000000000000">AIVM-THETA: Standard</option>
                <option value="0x4a8c30d500000000000000000000000000000000000000000000000000000000">AIVM-DELTA: High-Speed</option>
                <option value="0x6f63a19b3cf486000000000000000000000000000000000000000000000000">AIVM-SIGMA: Neural HD</option>
            </select>
            <button id="gen-btn" class="btn" onclick="runInference()">GENERATE</button>
        </div>
        <div class="canvas">
            <div id="loader" class="loader"></div>
            <p id="status-overlay">Awaiting Neural Link...</p>
            <img id="img-display" alt="AIVM Output">
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = ethers.getAddress("0xB6FbB06e865f1784A74F5953051C3782729FD04E");

        async function runInference() {
            const prompt = document.getElementById('prompt-input').value;
            const digest = document.getElementById('model-digest').value;
            const btn = document.getElementById('gen-btn');
            const loader = document.getElementById('loader');
            const status = document.getElementById('status-overlay');
            const img = document.getElementById('img-display');

            if (!prompt) return alert("Prompt required for inference.");

            try {
                btn.disabled = true;
                loader.style.display = 'block';
                img.style.display = 'none';
                status.innerText = "Broadcasting to Lightchain...";
                
                window.parent.postMessage({type: 'AIVM_METRICS', status: 'pending'}, '*');

                const provider = new ethers.BrowserProvider(window.ethereum);
                const network = await provider.getNetwork();
                if (network.chainId !== 504n) {
                    throw new Error("Wrong Network. Switch to Custom 504.");
                }

                const signer = await provider.getSigner();
                const contract = new ethers.Contract(
                    CONTRACT_ADDRESS, 
                    ["function generateArt(string prompt, bytes32 modelDigest) public payable"], 
                    signer
                );

                const tx = await contract.generateArt(prompt, digest, { 
                    value: ethers.parseEther("0.25"),
                    gasLimit: 1500000 
                });

                status.innerText = "Mining Neural Request...";
                await tx.wait();

                status.style.display = 'none';
                loader.style.display = 'none';
                
                const seed = Math.floor(Math.random() * 1000000);
                img.src = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1024&height=1024&nologo=true&seed=${seed}`;
                img.style.display = 'block';

                window.parent.postMessage({type: 'AIVM_METRICS', status: 'success'}, '*');
                btn.disabled = false;

            } catch (err) {
                console.error(err);
                status.innerText = err.message || "Inference Rejected by Chain";
                status.style.color = "#ff4444";
                loader.style.display = 'none';
                btn.disabled = false;
                window.parent.postMessage({type: 'AIVM_METRICS', status: 'error'}, '*');
            }
        }
    </script>
</body>
</html>
