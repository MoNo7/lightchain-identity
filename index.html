<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | Art Studio & Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #007bff; --admin-blue: #0056b3; --bg: #f0f2f5; --text: #1c1e21; --success: #28a745; --owner: #6f42c1; --warning: #f0ad4e; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #topNav { height: 60px; background: #fff; border-bottom: 1px solid #e1e4e8; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
        .token-display { background: #f8f9fa; padding: 8px 15px; border-radius: 20px; border: 1px solid #e1e4e8; font-weight: 700; font-size: 0.85rem; color: var(--success); }
        .content-wrapper { display: flex; flex: 1; overflow: hidden; }
        #leftSidebar, #rightSidebar { width: 320px; background: #fff; padding: 20px; overflow-y: auto; border-right: 1px solid #e1e4e8; box-sizing: border-box; }
        #rightSidebar { border-right: none; border-left: 1px solid #e1e4e8; }
        .main-utility-area { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e1e4e8; width: 100%; box-sizing: border-box; }
        .primary-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; margin-top: 10px; transition: opacity 0.2s; }
        .primary-btn:hover { opacity: 0.9; }
        .primary-btn:disabled { background: #ccc; cursor: not-allowed; }
        .result-window { margin-top: 20px; padding: 15px; background: #fdfdfd; border: 2px dashed #cbd5e0; border-radius: 8px; min-height: 150px; display: flex; align-items: center; justify-content: center; text-align: center; flex-direction: column; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; box-sizing: border-box; }
        .pulsing-text { animation: pulse 1.5s infinite; color: var(--warning); font-weight: bold; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="topNav">
        <h1 style="font-size: 1.1rem; color: #0056b3; margin: 0;">Identity & Art Portal</h1>
        <div class="token-display"><span id="tokenBalance">0.0000</span> LCAI</div>
    </div>
    <div class="content-wrapper">
        <div id="leftSidebar">
            <div class="card" style="text-align: center;">
                <div id="userProfile" style="display:none; margin-bottom:15px;">
                    <div id="userNameDisplay" style="font-size: 1.1rem; font-weight:800; color: #0056b3;"></div>
                    <div id="verifyTag" style="font-size: 0.65rem; font-weight: bold;">CONNECTED</div>
                </div>
                <button id="connectBtn" class="primary-btn">Connect Wallet</button>
            </div>
            
            <div id="zkPassSection" class="card" style="display:none; border-top: 4px solid var(--owner);">
                <h4 style="color:var(--owner); margin: 0 0 10px 0;">zkPass Verification</h4>
                <p style="font-size: 0.8rem; color: #666;">Verify your zero-knowledge credentials to unlock AI image generation.</p>
                <div id="zkStatusBadge" style="padding: 8px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; text-align: center; background: #f8d7da; color: #721c24; margin-bottom: 10px;">Unverified</div>
                <button id="verifyZkBtn" class="primary-btn" style="background: var(--owner);">Generate & Verify ZK Proof</button>
            </div>
        </div>

        <div class="main-utility-area">
            <div id="artUI" style="display:none; width: 100%; max-width: 600px;">
                <div class="card" style="border-top: 4px solid var(--success);">
                    <h2 style="margin-top: 0;">AIVM Art Studio (SDXL)</h2>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">Enter a prompt to generate an image via the Lightchain AI Cluster.</p>
                    <input type="text" id="artPrompt" placeholder="e.g., A futuristic cyberpunk city at sunset, highly detailed...">
                    <button id="generateArtBtn" class="primary-btn" style="background: var(--success);" disabled>Generate Art (0.25 LCAI)</button>
                    
                    <div class="result-window" id="artResultWindow">
                        <span style="color: #999;">Awaiting inference command...</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="rightSidebar">
            <div class="card">
                <h4 style="margin:0;">Cluster Logs</h4>
                <div id="txFeed" style="font-size: 0.75rem; margin-top:10px; max-height: 400px; overflow-y:auto; word-break: break-all;"></div>
            </div>
        </div>
    </div>

    <script>
        const IDENTITY_CONTRACT = "0xe0087e581f11b9de0d61697a0cb0cdffca8f1f34";
        const ART_CONTRACT_ADDR = "0xd17F12ef2C5d95e135094100a14D3d7569505d89"; 
        const IDENTITY_ABI = ["function getIdentity(address) view returns (string, string, bool)"];
        const ART_ABI = [
            "function generateArt(string _prompt) payable",
            "function verifyZkPass(bytes proof)",
            "function isZkVerified(address) view returns (bool)",
            "event ArtRequested(address indexed user, string prompt, bytes32 taskId)",
            "event ArtCompleted(address indexed user, string imageUrl, bytes32 taskId)",
            "event ZkPassVerified(address indexed user)"
        ];
        
        let signer, artContract, identityContract, provider;

        function logToSidebar(msg) {
            const feed = document.getElementById('txFeed');
            const entry = document.createElement('div');
            entry.style.borderBottom = "1px solid #eee"; entry.style.padding = "5px 0";
            entry.innerHTML = `<span style="color:#666">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            feed.prepend(entry);
        }

        async function hardSync() {
            const address = await signer.getAddress();
            const [profile, balance, zkVerified] = await Promise.all([
                identityContract.getIdentity(address),
                provider.getBalance(address),
                artContract.isZkVerified(address)
            ]);
            
            // Update Identity Profile
            document.getElementById('tokenBalance').innerText = parseFloat(ethers.formatEther(balance)).toFixed(4);
            document.getElementById('userNameDisplay').innerText = profile[0] || "Anonymous User";
            document.getElementById('verifyTag').innerText = profile[2] ? "GLOBAL ID VERIFIED" : "ID UNVERIFIED";
            document.getElementById('verifyTag').style.color = profile[2] ? "var(--success)" : "var(--danger)";
            
            // Update ZK Status
            const zkBadge = document.getElementById('zkStatusBadge');
            const genBtn = document.getElementById('generateArtBtn');
            if (zkVerified) {
                zkBadge.innerText = "ZK Pass Verified";
                zkBadge.style.background = "#d4edda";
                zkBadge.style.color = "#155724";
                document.getElementById('verifyZkBtn').style.display = "none";
                genBtn.disabled = false;
                genBtn.innerText = "Generate Art (0.25 LCAI)";
            } else {
                genBtn.disabled = true;
                genBtn.innerText = "Requires ZK Pass Verification";
            }
        }

        async function connectWallet() {
            if (!window.ethereum) return alert("Install MetaMask");
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            const myAddr = await signer.getAddress();
            
            artContract = new ethers.Contract(ART_CONTRACT_ADDR, ART_ABI, signer);
            identityContract = new ethers.Contract(IDENTITY_CONTRACT, IDENTITY_ABI, signer);

            // Set up Listeners
            artContract.on("ArtRequested", (user, p, taskId) => { 
                if(user.toLowerCase() === myAddr.toLowerCase()) {
                    logToSidebar(`Inference Requested: ${taskId.substring(0,10)}...`); 
                }
            });
            
            artContract.on("ZkPassVerified", (user) => {
                if(user.toLowerCase() === myAddr.toLowerCase()) {
                    logToSidebar("zkPass verification confirmed on-chain.");
                    hardSync();
                }
            });

            artContract.on("ArtCompleted", async (user, imageUrl, taskId) => {
                if (user.toLowerCase() === myAddr.toLowerCase()) {
                    logToSidebar(`AIVM Callback Received! Task: ${taskId.substring(0,10)}`);
                    const box = document.getElementById('artResultWindow');
                    box.innerHTML = `
                        <div style="color: var(--success); font-weight: bold; margin-bottom: 10px;">Inference Complete!</div>
                        <img src="${imageUrl}" alt="AI Generated Art" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    `;
                    await hardSync();
                }
            });

            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('userProfile').style.display = 'block';
            document.getElementById('zkPassSection').style.display = 'block';
            document.getElementById('artUI').style.display = 'block';
            await hardSync();
        }

        // Handle ZK Verification
        document.getElementById('verifyZkBtn').onclick = async () => {
            try {
                logToSidebar("Generating local ZK proof...");
                // Create a mock proof for testnet purposes
                const mockProof = ethers.keccak256(ethers.toUtf8Bytes(Date.now().toString()));
                
                const tx = await artContract.verifyZkPass(mockProof);
                logToSidebar(`Submitting ZK proof to network...`);
                await tx.wait();
            } catch (e) {
                alert("Error verifying ZK Pass: " + (e.reason || e.message));
            }
        };

        // Handle Art Generation
        document.getElementById('generateArtBtn').onclick = async () => {
            const prompt = document.getElementById('artPrompt').value;
            if (!prompt) return alert("Please enter a prompt.");
            const box = document.getElementById('artResultWindow');
            try {
                box.innerHTML = '<span class="pulsing-text">Anchoring request to Lightchain...</span>';
                const tx = await artContract.generateArt(prompt, { value: ethers.parseEther("0.25") });
                await tx.wait();
                box.innerHTML = '<span class="pulsing-text">Transaction confirmed. Waiting for AIVM Cluster inference (approx 30-60s)...</span>';
            } catch (e) { 
                box.innerHTML = `<span style="color: var(--danger);">Error: ${e.reason || e.message}</span>`; 
            }
        };

        window.onload = () => { document.getElementById('connectBtn').onclick = connectWallet; };
    </script>
</body>
</html>


