<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | IAM Control Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --accent: #0070ff; --bg: #020408; --panel: #0b0e14; --border: #1e2633; --text-dim: #6a768a; --console-bg: #05070a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        nav { width: 280px; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 25px; background: var(--panel); box-sizing: border-box; }
        .nav-logo { font-weight: 900; letter-spacing: 2px; color: var(--accent); margin-bottom: 25px; font-size: 1.1rem; text-align: center; }
        .system-console { background: var(--console-bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.65rem; height: 200px; overflow-y: auto; margin-bottom: 20px; color: #4e5d75; line-height: 1.5; }
        .console-line { margin-bottom: 4px; border-left: 2px solid #1a202c; padding-left: 8px; }
        .console-line.success { border-left-color: var(--accent); color: #fff; }
        .console-line.error { border-left-color: #ff4444; color: #ff4444; }
        .nav-menu { display: none; flex-direction: column; gap: 5px; }
        .nav-link { color: var(--text-dim); padding: 12px 15px; cursor: pointer; border-radius: 6px; border: none; background: none; text-align: left; font-size: 0.75rem; font-family: monospace; width: 100%; font-weight: 600; }
        .nav-link:hover, .nav-link.active { color: white; background: var(--accent); }
        .viewport { flex: 1; display: flex; flex-direction: column; }
        header { height: 80px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-sizing: border-box; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .pill { background: #000; border: 1px solid var(--border); border-radius: 50px; padding: 7px 20px; font-size: 0.7rem; color: var(--accent); font-family: monospace; display: flex; align-items: center; gap: 8px; }
        .wallet-pill { background: var(--accent); color: white; border-radius: 50px; padding: 9px 20px; font-weight: 900; cursor: pointer; border: none; font-size: 0.75rem; }
        .view-pane { flex: 1; padding: 45px; display: none; overflow-y: auto; }
        .view-pane.active { display: block !important; }
        .card { background: var(--panel); border: 1px solid var(--border); padding: 35px; border-radius: 12px; max-width: 750px; border-top: 4px solid var(--accent); margin-bottom: 20px; }
        .panel-input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 4px; font-size: 0.75rem; margin-bottom: 12px; box-sizing: border-box; font-family: monospace; }
        .action-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; width: 100%; font-weight: bold; }
        .action-btn.alt { background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-top: 8px; }
        pre { background: var(--console-bg); padding: 20px; border-radius: 8px; font-size: 0.75rem; color: #a0aec0; white-space: pre-wrap; border: 1px solid var(--border); line-height: 1.4; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
        .gallery-item { background: #000; border: 1px solid var(--border); border-radius: 6px; padding: 8px; text-align: center; }
        .gallery-item img { width: 100%; height: 110px; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body>

<nav>
    <div class="nav-logo">LCAI <span>IAM</span></div>
    <div class="system-console" id="console">
        <div class="console-line">>> CORE_LOADED</div>
    </div>
    <div class="nav-menu" id="side-menu">
        <button class="nav-link active" onclick="showView('id-view', this)">ZK IDENTITY</button>
        <button class="nav-link" onclick="showView('admin-view', this)">ADMIN PANEL</button>
        <button class="nav-link" onclick="showView('treasury-view', this)">TREASURY VAULT</button>
        <button class="nav-link" onclick="showView('aivm-view', this)">LCAI AIVM ART</button>
        <button class="nav-link" onclick="showView('gallery-view', this); initGallery();">NETWORK GALLERY</button>
    </div>
</nav>

<div class="viewport">
    <header>
        <div class="pill">
            <span style="color:var(--text-dim)">MODEL:</span> 
            <span id="active-model">AIVM-THETA</span> 
            <span style="color:var(--text-dim)">|</span> 
            <span id="load-num">0%</span> 
            <span id="status-txt">IDLE</span>
        </div>
        <div class="header-right">
            <button id="wallet-btn" class="wallet-pill" onclick="connectWallet()">CONNECT WALLET</button>
        </div>
    </header>

    <div id="id-view" class="view-pane active">
        <div class="card">
            <h2>ZK-SBT IDENTITY</h2>
            <pre id="id-json">{ "status": "awaiting_connection" }</pre>
            <div id="qr-target" style="margin-top:20px; background:white; padding:10px; display:inline-block; border-radius:4px;"></div>
        </div>
    </div>

    <div id="admin-view" class="view-pane">
        <div class="card">
            <h2>IDENTITY RECOVERY & OPS</h2>
            <p style="font-size:0.7rem; color:var(--text-dim); margin-bottom:20px;">Manual verification override for GUEST_NODES.</p>
            <input type="text" class="panel-input" id="admin-addr" placeholder="Target Operator Address (0x...)">
            <button class="action-btn" onclick="runAdmin('query')">QUERY STATUS</button>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="action-btn alt" onclick="runAdmin('verify')" style="flex:1">VERIFY USER</button>
                <button class="action-btn alt" onclick="runAdmin('revoke')" style="flex:1; border-color:#ff4444; color:#ff4444;">REVOKE USER</button>
            </div>
        </div>
    </div>

    <div id="treasury-view" class="view-pane">
        <div class="card">
            <h2>REVENUE & WITHDRAWAL</h2>
            <div style="background:#000; padding:25px; border-radius:8px; margin-bottom:20px; border:1px solid var(--border); text-align:center;">
                <div style="font-size:0.65rem; color:var(--text-dim); letter-spacing:1px;">CONTRACT ASSETS</div>
                <div id="revenue-val" style="font-size:2rem; color:var(--accent); font-weight:900; margin:10px 0;">0.00 tLCAI</div>
            </div>
            <button class="action-btn" onclick="runOwner()" style="height:50px; font-size:0.8rem;">WITHDRAW ALL FUNDS</button>
        </div>
    </div>

    <div id="aivm-view" class="view-pane">
        <div class="card">
            <h2>LCAI AIVM INFERENCE</h2>
            <select id="model-select" class="panel-input" onchange="document.getElementById('active-model').innerText=this.value">
                <option value="AIVM-THETA">AIVM-THETA (Standard)</option>
                <option value="AIVM-SIGMA">AIVM-SIGMA (HD)</option>
                <option value="AIVM-OMEGA">AIVM-OMEGA (Experimental)</option>
            </select>
            <textarea id="art-prompt" class="panel-input" placeholder="Enter prompt..." style="height:120px;"></textarea>
            <button class="action-btn" onclick="generateArt()">REQUEST INFERENCE (0.001 tLCAI)</button>
        </div>
    </div>

    <div id="gallery-view" class="view-pane">
        <div class="card" style="max-width: 900px;">
            <h2>NETWORK GALLERY</h2>
            <button class="action-btn alt" onclick="initGallery()" style="width:auto; padding:5px 15px;">REFRESH SCAN</button>
            <div class="gallery-grid" id="gallery-grid"></div>
        </div>
    </div>
</div>

<script>
const CONFIG = {
    addr: "0xbcA38515887Dc3Ca163398C0Ef7bF02dd156D8FB",
    abi: [
        "function owner() public view returns (address)",
        "function setVerification(address user, bool status) external",
        "function withdraw() external",
        "function manualVerified(address) public view returns (bool)",
        "function requestInference(string prompt) external payable",
        "event InferenceRequested(address indexed user, string prompt)"
    ]
};

let user, provider, signer, contract;

const log = (msg, type = "info") => {
    const cb = document.getElementById('console');
    const l = document.createElement('div');
    l.className = `console-line ${type === 'success' ? 'success' : type === 'error' ? 'error' : ''}`;
    l.innerText = `>> ${msg}`;
    cb.appendChild(l);
    cb.scrollTop = cb.scrollHeight;
};

async function connectWallet() {
    if (!window.ethereum) return log("METAMASK NOT FOUND", "error");
    try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        user = accounts[0];
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONFIG.addr, CONFIG.abi, signer);
        
        const ownerAddr = await contract.owner();
        const isOwner = (user.toLowerCase() === ownerAddr.toLowerCase());
        const isVerified = await contract.manualVerified(user);

        log(`SESSION_START: ${user.slice(0,10)}`, "success");

        // RESTORE FULL IDENTITY METADATA
        const idData = {
            "identity": {
                "operator_id": `LCAI-${user.slice(2, 8).toUpperCase()}`,
                "role": isOwner ? "SYSTEM_OWNER_ADMIN" : (isVerified ? "VERIFIED_OPERATOR" : "GUEST_NODE"),
                "access_tier": isOwner ? "OMEGA_ACCESS" : (isVerified ? "STANDARD_ACCESS" : "LIMITED"),
                "auth_method": "ZK_SBT_HANDSHAKE",
                "timestamp": Math.floor(Date.now() / 1000)
            },
            "network": { "address": user, "contract": CONFIG.addr, "is_owner": isOwner }
        };

        document.getElementById('id-json').innerText = JSON.stringify(idData, null, 4);
        document.getElementById('wallet-btn').innerText = user.slice(0,6).toUpperCase();
        document.getElementById('side-menu').style.display = 'flex';
        
        if(isOwner) log("ADMIN PRIVILEGES GRANTED", "success");

        document.getElementById('qr-target').innerHTML = "";
        new QRCode(document.getElementById("qr-target"), { text: user, width: 120, height: 120 });
        
        refreshBalance();
    } catch (e) { log("CONNECTION FAILED", "error"); }
}

async function runAdmin(type) {
    const target = document.getElementById('admin-addr').value;
    if(!target || !contract) return log("INPUT REQUIRED", "error");
    try {
        if(type === 'query') {
            const res = await contract.manualVerified(target);
            log(`USER ${target.slice(0,6)}: ${res ? "VERIFIED" : "UNVERIFIED"}`);
        } else {
            log("BROADCASTING UPDATE...");
            const tx = await contract.setVerification(target, type === 'verify');
            await tx.wait();
            log("PERMISSION UPDATED", "success");
        }
    } catch (e) { log("ADMIN REVERTED", "error"); }
}

async function runOwner() {
    if(!contract) return;
    try {
        log("INITIATING TREASURY WITHDRAWAL...");
        const tx = await contract.withdraw();
        log("TX SENT: " + tx.hash.slice(0,10));
        await tx.wait();
        log("VAULT WITHDRAWN", "success");
        refreshBalance();
    } catch (e) { log("WITHDRAWAL FAILED: CHECK BALANCE/AUTH", "error"); }
}

async function generateArt() {
    if(!contract) return;
    const prompt = document.getElementById('art-prompt').value;
    const model = document.getElementById('model-select').value;
    try {
        document.getElementById('status-txt').innerText = "INFERENCE";
        document.getElementById('load-num').innerText = "20%";
        const tx = await contract.requestInference(`[${model}] ${prompt}`, { value: ethers.parseEther("0.001") });
        document.getElementById('load-num').innerText = "60%";
        await tx.wait();
        log("INFERENCE SUCCESSFUL", "success");
        document.getElementById('load-num').innerText = "100%";
        document.getElementById('status-txt').innerText = "IDLE";
    } catch (e) { 
        log("INFERENCE REJECTED", "error");
        document.getElementById('status-txt').innerText = "IDLE";
    }
}

async function initGallery() {
    if(!contract) return;
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = "SCANNING...";
    try {
        const events = await contract.queryFilter("InferenceRequested", -5000);
        grid.innerHTML = events.length === 0 ? "EMPTY" : "";
        events.reverse().forEach(ev => {
            grid.innerHTML += `<div class="gallery-item"><img src="https://picsum.photos/seed/${ev.transactionHash}/150/110"></div>`;
        });
    } catch (e) { grid.innerHTML = "SYNC ERROR"; }
}

async function refreshBalance() {
    if(!provider) return;
    try {
        const bal = await provider.getBalance(CONFIG.addr);
        document.getElementById('revenue-val').innerText = `${ethers.formatEther(bal).slice(0,6)} tLCAI`;
    } catch(e) {}
}

function showView(id, btn) {
    document.querySelectorAll('.view-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}
</script>
</body>
</html>
