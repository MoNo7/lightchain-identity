<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | Oracle Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #f0f2f5; --text: #1c1e21; --success: #28a745; --warning: #f0ad4e; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #topNav { height: 60px; background: #fff; border-bottom: 1px solid #e1e4e8; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
        .token-display { background: #f8f9fa; padding: 8px 15px; border-radius: 20px; border: 1px solid #e1e4e8; font-weight: 700; color: var(--success); }
        .content-wrapper { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 320px; background: #fff; padding: 20px; border-right: 1px solid #e1e4e8; }
        .main-area { flex: 1; padding: 40px; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e1e4e8; width: 100%; max-width: 500px; text-align: center; }
        .primary-btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; }
        .result-window { margin-top: 20px; padding: 20px; background: #1a1a1a; color: #00ff00; border-radius: 8px; font-family: 'Courier New', monospace; min-height: 100px; text-align: left; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        .log-entry { font-size: 0.75rem; border-bottom: 1px solid #eee; padding: 5px 0; color: #666; }
        .pulsing { animation: pulse 1.5s infinite; color: var(--warning); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="topNav">
        <h1 style="font-size: 1.1rem; color: #0056b3; margin: 0;">AIVM Oracle Portal</h1>
        <div class="token-display"><span id="tokenBalance">0.0000</span> LCAI</div>
    </div>
    <div class="content-wrapper">
        <div id="sidebar">
            <div class="card" style="margin-bottom: 20px;">
                <h3 id="userName">Not Connected</h3>
                <span id="statusTag" style="font-weight: bold; font-size: 0.8rem;"></span>
                <button id="connectBtn" class="primary-btn" style="margin-top:15px;">Connect Wallet</button>
            </div>
            <div class="card">
                <h4 style="margin:0 0 10px 0;">Cluster Logs</h4>
                <div id="txFeed"></div>
            </div>
        </div>
        <div class="main-area">
            <div id="oracleUI" style="display:none; width: 100%; max-width: 500px;">
                <div class="card">
                    <h2>Magic 8-Ball AI</h2>
                    <input type="text" id="question" placeholder="Ask the cluster...">
                    <button id="askBtn" class="primary-btn" style="background: var(--success);">Ask Oracle (0.15 LCAI)</button>
                    <div class="result-window" id="resultText">> Awaiting command...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ID_ADDR = "0xe0087e581f11b9de0d61697a0cb0cdffca8f1f34";
        const BALL_ADDR = "0xa32D6b69f075a4B6F92b45Bc26a5C5D0615E2D6c"; 
        
        const ABI = [
            "function getPrediction(string _question) payable",
            "function latestAnswer(address) view returns (string)",
            "event OracleAnswer(address indexed user, string answer, bytes32 taskId)",
            "event OracleRequest(address indexed user, string question, bytes32 taskId)"
        ];
        const ID_ABI = ["function getIdentity(address) view returns (string, string, bool)"];
        
        let signer, contract, idContract, provider;

        function log(msg) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('txFeed').prepend(entry);
        }

        async function connect() {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            const addr = await signer.getAddress();
            contract = new ethers.Contract(BALL_ADDR, ABI, signer);
            idContract = new ethers.Contract(ID_ADDR, ID_ABI, signer);

            const [id, bal, lastAns] = await Promise.all([
                idContract.getIdentity(addr),
                provider.getBalance(addr),
                contract.latestAnswer(addr)
            ]);

            document.getElementById('tokenBalance').innerText = parseFloat(ethers.formatEther(bal)).toFixed(4);
            document.getElementById('userName').innerText = id[0] || "User: " + addr.substring(0,6);
            document.getElementById('statusTag').innerText = id[2] ? "VERIFIED" : "UNVERIFIED";
            document.getElementById('statusTag').style.color = id[2] ? "green" : "red";
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('oracleUI').style.display = 'block';
            if (lastAns) document.getElementById('resultText').innerText = "> Oracle: " + lastAns;

            contract.on("OracleRequest", (u, q, id) => log(`Request: ${q.substring(0,10)}...`));
            contract.on("OracleAnswer", (u, a) => {
                if (u.toLowerCase() === addr.toLowerCase()) {
                    document.getElementById('resultText').innerText = "> Oracle: " + a;
                    log("AI Callback Received!");
                }
            });
        }

        document.getElementById('askBtn').onclick = async () => {
            const q = document.getElementById('question').value;
            const res = document.getElementById('resultText');
            try {
                res.innerHTML = '<span class="pulsing">> Sending request...</span>';
                const tx = await contract.getPrediction(q, { value: ethers.parseEther("0.15") });
                log(`Tx: ${tx.hash.substring(0,10)}...`);
                await tx.wait();
                res.innerHTML = '<span class="pulsing">> Request confirmed. Awaiting AI...</span>';
            } catch (e) {
                res.innerText = "> Error: " + (e.reason || "Reverted. Check Portal status.");
            }
        };

        document.getElementById('connectBtn').onclick = connect;
    </script>
</body>
</html>
