<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | IAM Control Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --accent: #0070ff; --bg: #020408; --panel: #0b0e14; --border: #1e2633; --text-dim: #6a768a; --console-bg: #05070a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        nav { width: 280px; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 25px; background: var(--panel); box-sizing: border-box; }
        .nav-logo { font-weight: 900; letter-spacing: 2px; color: var(--accent); margin-bottom: 25px; font-size: 1.1rem; text-align: center; }
        .system-console { background: var(--console-bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.65rem; height: 160px; overflow-y: auto; margin-bottom: 20px; color: #4e5d75; line-height: 1.5; }
        .console-line { margin-bottom: 4px; border-left: 2px solid #1a202c; padding-left: 8px; }
        .console-line.success { border-left-color: var(--accent); color: #fff; }
        .console-line.error { border-left-color: #ff4444; color: #ff4444; }
        .nav-menu { display: flex; flex-direction: column; gap: 5px; }
        .nav-link { color: var(--text-dim); padding: 12px 15px; cursor: pointer; border-radius: 6px; border: none; background: none; text-align: left; font-size: 0.75rem; font-family: monospace; width: 100%; font-weight: 600; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { color: white; background: var(--accent); }
        .viewport { flex: 1; display: flex; flex-direction: column; }
        header { height: 80px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-sizing: border-box; }
        .pill { background: #000; border: 1px solid var(--border); border-radius: 50px; padding: 7px 20px; font-size: 0.7rem; color: var(--accent); font-family: monospace; display: flex; align-items: center; gap: 8px; }
        .wallet-pill { background: var(--accent); color: white; border-radius: 50px; padding: 9px 20px; font-weight: 900; cursor: pointer; border: none; font-size: 0.75rem; }
        .view-pane { flex: 1; padding: 45px; display: none; overflow-y: auto; }
        .view-pane.active { display: block !important; }
        .card { background: var(--panel); border: 1px solid var(--border); padding: 35px; border-radius: 12px; max-width: 750px; border-top: 4px solid var(--accent); margin-bottom: 20px; }
        .panel-input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 4px; font-size: 0.75rem; margin-bottom: 12px; box-sizing: border-box; font-family: monospace; }
        .action-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; width: 100%; font-weight: bold; }
        .action-btn.alt { background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-top: 8px; }
        pre { background: var(--console-bg); padding: 20px; border-radius: 8px; font-size: 0.75rem; color: #a0aec0; white-space: pre-wrap; border: 1px solid var(--border); line-height: 1.4; cursor: pointer; }
        pre:hover { border-color: var(--accent); color: #fff; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .gallery-item { background: #000; border: 1px solid var(--border); border-radius: 6px; padding: 10px; text-align: center; }
        .gallery-item img { width: 100%; height: 130px; object-fit: cover; border-radius: 4px; filter: blur(2px); transition: 0.3s; }
        .gallery-item.high-res img { filter: blur(0); }
        .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; background: #00c853; color: white; vertical-align: middle; }
    </style>
</head>
<body>

<nav>
    <div class="nav-logo">LCAI <span>IAM</span></div>
    <div class="system-console" id="console">
        <div class="console-line">>> INITIALIZING_SECURE_KERNEL</div>
    </div>
    <div class="nav-menu" id="side-menu">
        <button class="nav-link active" onclick="showView('gallery-view', this); initGallery();">NETWORK GALLERY</button>
    </div>
</nav>

<div class="viewport">
    <header>
        <div class="pill">
            <span style="color:var(--text-dim)">MODEL:</span> 
            <span id="active-model">AIVM-THETA</span> 
            <span style="color:var(--text-dim)">|</span> 
            <span id="load-num">0%</span> 
            <span id="status-txt">IDLE</span>
        </div>
        <div class="header-right">
            <button id="wallet-btn" class="wallet-pill" onclick="connectWallet()">CONNECT WALLET</button>
        </div>
    </header>

    <div id="gallery-view" class="view-pane active">
        <div class="card" style="max-width: 900px;">
            <h2>NETWORK GALLERY <span id="gallery-badge"></span></h2>
            <p style="font-size:0.7rem; color:var(--text-dim);">Low-resolution preview (Public). Verified Users unlock HD viewing.</p>
            <div class="gallery-grid" id="gallery-grid"></div>
        </div>
    </div>

    <div id="id-view" class="view-pane">
        <div class="card">
            <h2>ZK-SBT IDENTITY CARD</h2>
            <p style="font-size:0.65rem; color:var(--text-dim); margin-bottom:10px;">Click the code block below to download JSON Identity metadata.</p>
            <pre id="id-json" onclick="saveJSON()">// Identity Packet Offline: Handshake Required</pre>
            <div id="qr-target" onclick="saveQR()" style="margin-top:20px; background:white; padding:10px; display:none; border-radius:4px; cursor:pointer;" title="Click to Download QR Image"></div>
            <p id="qr-hint" style="display:none; font-size:0.65rem; color:var(--text-dim); margin-top:8px;">Click QR Code to Download .png image</p>
        </div>
    </div>

    <div id="admin-view" class="view-pane">
        <div class="card">
            <h2>ADMIN OPS</h2>
            <input type="text" class="panel-input" id="admin-addr" placeholder="Target Operator Address (0x...)">
            <button class="action-btn" onclick="runAdmin('query')">QUERY STATUS</button>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="action-btn alt" onclick="runAdmin('verify')" style="flex:1">VERIFY USER</button>
                <button class="action-btn alt" onclick="runAdmin('revoke')" style="flex:1; border-color:#ff4444; color:#ff4444;">REVOKE USER</button>
            </div>
        </div>
    </div>

    <div id="treasury-view" class="view-pane">
        <div class="card">
            <h2>TREASURY VAULT</h2>
            <div style="background:#000; padding:25px; border-radius:8px; margin-bottom:20px; border:1px solid var(--border); text-align:center;">
                <div style="font-size:0.65rem; color:var(--text-dim); letter-spacing:1px;">CONTRACT ASSETS</div>
                <div id="revenue-val" style="font-size:2rem; color:var(--accent); font-weight:900; margin:10px 0;">0.00 tLCAI</div>
            </div>
            <button class="action-btn" onclick="runOwner()" style="height:50px; font-size:0.8rem;">WITHDRAW ALL FUNDS</button>
        </div>
    </div>

    <div id="aivm-view" class="view-pane">
        <div class="card">
            <h2>AIVM INFERENCE</h2>
            <select id="model-select" class="panel-input" onchange="document.getElementById('active-model').innerText=this.value">
                <option value="AIVM-THETA">AIVM-THETA (Standard)</option>
                <option value="AIVM-SIGMA">AIVM-SIGMA (HD)</option>
                <option value="AIVM-OMEGA">AIVM-OMEGA (Experimental)</option>
            </select>
            <textarea id="art-prompt" class="panel-input" placeholder="Neural landscape..." style="height:120px;"></textarea>
            <button class="action-btn" onclick="generateArt()">REQUEST INFERENCE (0.001 tLCAI)</button>
        </div>
    </div>
</div>

<script>
const CONFIG = {
    addr: "0x5B2d46cb1e3451aA3d584f28E714892373D7c7C6", // UPDATED TO CURRENT DEPLOYED ADDRESS
    abi: [
        "function owner() public view returns (address)",
        "function setVerification(address user, bool status) external",
        "function withdraw() external",
        "function manualVerified(address) public view returns (bool)",
        "function requestInference(string prompt) external payable",
        "event InferenceRequested(address indexed user, string prompt)"
    ]
};

let user, provider, signer, contract, roles = { isOwner: false, isVerified: false };

const log = (msg, type = "info") => {
    const cb = document.getElementById('console');
    const l = document.createElement('div');
    l.className = `console-line ${type === 'success' ? 'success' : type === 'error' ? 'error' : ''}`;
    l.innerText = `>> ${msg}`;
    cb.appendChild(l);
    cb.scrollTop = cb.scrollHeight;
};

async function connectWallet() {
    if (!window.ethereum) return log("METAMASK MISSING", "error");
    try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        user = accounts[0];
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONFIG.addr, CONFIG.abi, signer);
        
        const ownerAddr = await contract.owner();
        roles.isOwner = (user.toLowerCase() === ownerAddr.toLowerCase());
        roles.isVerified = await contract.manualVerified(user);

        log(`STREAK_SYNC: ${user.slice(0,10)}`, "success");
        updateMenu();
        updateIdentity();
        initGallery();
        refreshBalance();
        
        document.getElementById('wallet-btn').innerText = user.slice(0,6).toUpperCase();
    } catch (e) { log("HANDSHAKE FAILED", "error"); }
}

function updateMenu() {
    const menu = document.getElementById('side-menu');
    let html = `<button class="nav-link" onclick="showView('gallery-view', this); initGallery();">NETWORK GALLERY</button>`;
    if(user) {
        html += `<button class="nav-link" id="id-link" onclick="showView('id-view', this)">ZK IDENTITY</button>`;
        if(roles.isOwner) {
            html += `<button class="nav-link" onclick="showView('admin-view', this)">ADMIN PANEL</button>`;
            html += `<button class="nav-link" onclick="showView('treasury-view', this)">TREASURY VAULT</button>`;
        }
        if(roles.isVerified || roles.isOwner) {
            html += `<button class="nav-link" onclick="showView('aivm-view', this)">LCAI AIVM ART</button>`;
        }
    }
    menu.innerHTML = html;
}

function updateIdentity() {
    const idData = {
        "identity": {
            "operator_id": `LCAI-${user.slice(2, 8).toUpperCase()}`,
            "role": roles.isOwner ? "SYSTEM_OWNER" : (roles.isVerified ? "VERIFIED_OPERATOR" : "GUEST_NODE"),
            "access_tier": roles.isOwner ? "OMEGA_ACCESS" : (roles.isVerified ? "STANDARD" : "LIMITED"),
            "auth_method": "ZK_SBT_HANDSHAKE",
            "timestamp": Math.floor(Date.now() / 1000)
        }
    };
    document.getElementById('id-json').innerText = JSON.stringify(idData, null, 4);
    document.getElementById('qr-target').style.display = "inline-block";
    document.getElementById('qr-hint').style.display = "block";
    document.getElementById('qr-target').innerHTML = "";
    new QRCode(document.getElementById("qr-target"), { text: JSON.stringify(idData), width: 140, height: 140 });
}

async function initGallery() {
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = "SCANNING...";
    try {
        const events = await contract.queryFilter("InferenceRequested", -5000);
        grid.innerHTML = events.length === 0 ? "EMPTY" : "";
        const isVerified = (roles.isVerified || roles.isOwner);
        if(isVerified) document.getElementById('gallery-badge').innerHTML = `<span class="badge">ZK-VERIFIED HD</span>`;

        events.reverse().forEach(ev => {
            let actions = "";
            if(isVerified) actions += `<button class="action-btn alt" style="font-size:0.5rem; padding:4px;" onclick="window.open('https://picsum.photos/seed/${ev.transactionHash}/1200/800')">HD VIEW</button>`;
            if(roles.isOwner) actions += `<button class="action-btn alt" style="font-size:0.5rem; padding:4px; border-color:#00c853; color:#00c853;" onclick="log('MINT_REQUESTED', 'info')">MINT NFT</button>`;

            grid.innerHTML += `
                <div class="gallery-item ${isVerified ? 'high-res' : ''}">
                    <img src="https://picsum.photos/seed/${ev.transactionHash}/200/150">
                    <div style="margin-top:8px; display:flex; flex-direction:column; gap:4px;">
                        ${actions}
                    </div>
                </div>`;
        });
    } catch (e) { grid.innerHTML = "PUBLIC_PREVIEW_MODE"; }
}

async function runAdmin(type) {
    const target = document.getElementById('admin-addr').value;
    try {
        if(type === 'query') {
            const res = await contract.manualVerified(target);
            log(`USER ${target.slice(0,6)}: ${res ? "VERIFIED" : "UNVERIFIED"}`);
        } else {
            const tx = await contract.setVerification(target, type === 'verify', { gasLimit: 200000 });
            await tx.wait(); log("PERMISSION SYNCED", "success");
            if(target.toLowerCase() === user.toLowerCase()) { roles.isVerified = (type === 'verify'); updateMenu(); }
        }
    } catch (e) { log("ADMIN ACTION REVERTED", "error"); }
}

async function runOwner() {
    try {
        log("INITIATING WITHDRAWAL...");
        const tx = await contract.withdraw({ gasLimit: 200000 });
        await tx.wait(); log("VAULT WITHDRAWN", "success");
        refreshBalance();
    } catch (e) { log("WITHDRAWAL FAILED: CHECK BALANCE", "error"); }
}

async function generateArt() {
    const prompt = document.getElementById('art-prompt').value;
    try {
        document.getElementById('status-txt').innerText = "INFERENCE";
        const tx = await contract.requestInference(prompt, { 
            value: ethers.parseEther("0.001"),
            gasLimit: 800000 // HIGH GAS FOR AI INFERENCE ON TESTNET
        });
        await tx.wait();
        log("INFERENCE SUCCESSFUL", "success");
        document.getElementById('status-txt').innerText = "IDLE";
        initGallery();
    } catch (e) { log("INFERENCE REJECTED", "error"); document.getElementById('status-txt').innerText = "IDLE"; }
}

async function refreshBalance() {
    if(!provider) return;
    const bal = await provider.getBalance(CONFIG.addr);
    document.getElementById('revenue-val').innerText = `${ethers.formatEther(bal).slice(0,6)} tLCAI`;
}

function showView(id, btn) {
    document.querySelectorAll('.view-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

function saveJSON() {
    if(!user) return;
    const data = document.getElementById('id-json').innerText;
    const b = new Blob([data], {type:"application/json"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download=`LCAI_ID_${user.slice(0,6)}.json`; a.click();
    log("ID PACKET DOWNLOADED", "success");
}

function saveQR() {
    const qrImg = document.querySelector('#qr-target img');
    if(!qrImg) return;
    const link = document.createElement('a');
    link.href = qrImg.src;
    link.download = `LCAI_QR_${user.slice(0,6)}.png`;
    link.click();
    log("QR_CODE DOWNLOADED", "success");
}

initGallery();
</script>
</body>
</html>
