<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIVM Control Center | Lightchain AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <style>
        body { margin: 0; background: #050505; color: white; font-family: monospace; overflow: hidden; }
        header { position: fixed; top: 0; left: 0; right: 0; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 1px solid #222; z-index: 100; background: rgba(5,5,5,0.8); backdrop-filter: blur(10px); }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        
        /* Cluster Status Pill */
        .cluster-pill { display: flex; align-items: center; background: #000; border: 1px solid #333; border-radius: 50px; padding: 6px 18px; font-size: 0.7rem; color: #00ff80; cursor: pointer; transition: 0.3s; }
        .cluster-pill:hover { border-color: #00ff80; box-shadow: 0 0 10px rgba(0,255,128,0.2); }
        .c-tag { opacity: 0.5; margin-right: 10px; font-weight: bold; }
        .c-val { font-weight: 800; margin-right: 10px; min-width: 60px; }
        .c-stat { background: #222; color: #fff; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; font-size: 0.6rem; }

        /* Wallet Pill */
        .wallet-pill { background: #00ff80; color: #000; border-radius: 50px; padding: 7px 20px; font-size: 0.75rem; font-weight: 900; cursor: pointer; border: none; transition: 0.2s; box-shadow: 0 4px 15px rgba(0,255,128,0.2); }
        .wallet-pill:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,255,128,0.3); }

        main { margin-top: 70px; height: calc(100vh - 70px); width: 100vw; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

<header>
    <div class="logo" style="font-weight: 900; letter-spacing: 2px; color: #00ff80;">LIGHTCHAIN <span style="color:white">AIVM</span></div>
    
    <div class="nav-right">
        <div id="cluster-pill" class="cluster-pill" onclick="toggleCluster()">
            <span id="c-name" class="c-tag">AIVM-THETA</span>
            <span id="c-load" class="c-val">LOAD: 0%</span>
            <span id="c-status" class="c-stat">IDLE</span>
        </div>

        <button id="wallet-pill" class="wallet-pill" onclick="handleWalletAction()">CONNECT WALLET</button>
    </div>
</header>

<main>
    <iframe id="aivm-frame" src="artgenerator-ui.html"></iframe>
</main>

<script>
let userAddress = "";
const clusters = ["AIVM-THETA", "AIVM-DELTA", "AIVM-SIGMA"];
let currentClusterIdx = 0;

async function handleWalletAction() {
    if (!userAddress) {
        await connect();
    } else {
        await navigator.clipboard.writeText(userAddress);
        const btn = document.getElementById('wallet-pill');
        btn.innerText = "COPIED!";
        setTimeout(() => { btn.innerText = userAddress.slice(0,6).toUpperCase() + "..." + userAddress.slice(-4).toUpperCase(); }, 1000);
    }
}

async function connect() {
    if (!window.ethereum) { alert("Please install MetaMask"); return; }
    try {
        const provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send("eth_requestAccounts", []);
        userAddress = accounts[0];
        document.getElementById('wallet-pill').innerText = userAddress.slice(0,6).toUpperCase() + "..." + userAddress.slice(-4).toUpperCase();
        
        // Notify Iframe
        document.getElementById('aivm-frame').contentWindow.postMessage({ type: 'WALLET_CONNECTED', address: userAddress }, '*');
    } catch (e) {
        console.error("Connection Failed", e);
        document.getElementById('wallet-pill').innerText = "CONN FAILED";
    }
}

function toggleCluster() {
    currentClusterIdx = (currentClusterIdx + 1) % clusters.length;
    const newCluster = clusters[currentClusterIdx];
    document.getElementById('c-name').innerText = newCluster;
    // Notify Iframe to update model context if needed
    document.getElementById('aivm-frame').contentWindow.postMessage({ type: 'CLUSTER_CHANGED', cluster: newCluster }, '*');
}

window.addEventListener('message', (e) => {
    if (e.data.type === 'AIVM_METRICS') {
        document.getElementById('c-load').innerText = `LOAD: ${e.data.load}%`;
        const stat = document.getElementById('c-status');
        stat.innerText = e.data.status;
        stat.style.color = (e.data.status === 'mining') ? '#ffcc00' : (e.data.status === 'error' ? '#ff4444' : '#fff');
    }
});
</script>
</body>
</html>
