<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | Admin & Art Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #007bff; --admin: #6f42c1; --bg: #f0f2f5; --text: #1c1e21; --success: #28a745; --danger: #dc3545; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #topNav { height: 60px; background: #fff; border-bottom: 1px solid #e1e4e8; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
        .token-display { background: #f8f9fa; padding: 8px 15px; border-radius: 20px; border: 1px solid #e1e4e8; font-weight: 700; color: var(--success); }
        .content-wrapper { display: flex; flex: 1; overflow: hidden; }
        #leftSidebar { width: 340px; background: #fff; padding: 20px; overflow-y: auto; border-right: 1px solid #e1e4e8; }
        .main-area { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e1e4e8; width: 100%; box-sizing: border-box; }
        .primary-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; margin-top: 10px; }
        .admin-btn { background: var(--admin); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 0.85rem; margin-top: 5px; transition: 0.2s; }
        .admin-btn:hover { filter: brightness(1.1); }
        .result-window { margin-top: 20px; padding: 15px; background: #1a1a1a; color: #0f0; border-radius: 8px; min-height: 250px; display: flex; align-items: center; justify-content: center; text-align: center; flex-direction: column; border: 2px solid #333; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; box-sizing: border-box; }
        .status-pill { font-size: 0.7rem; font-weight: bold; padding: 4px 8px; border-radius: 10px; display: inline-block; margin-top: 5px; }
        .log-entry { font-size: 0.7rem; color: #666; border-bottom: 1px solid #eee; padding: 4px 0; }
        .pulsing { animation: pulse 1.5s infinite; color: var(--warning); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="topNav">
        <h1 style="font-size: 1.1rem; color: var(--admin); margin: 0;">Lightchain AIVM Studio</h1>
        <div class="token-display"><span id="tokenBalance">0.0000</span> LCAI</div>
    </div>

    <div class="content-wrapper">
        <div id="leftSidebar">
            <div class="card" style="text-align: center;">
                <div id="userProfile" style="display:none;">
                    <div id="userNameDisplay" style="font-weight:800; color: var(--primary);">Loading...</div>
                    <div id="verifyTag" class="status-pill"></div>
                </div>
                <button id="connectBtn" class="primary-btn">Connect Wallet</button>
            </div>

            <div id="adminMenu" class="card" style="display:none; border-top: 4px solid var(--admin);">
                <h4 style="margin: 0 0 10px 0; color: var(--admin);">Admin & Recovery</h4>
                <p style="font-size: 0.75rem; color: #666;">zkPass Proof generation for identity recovery.</p>
                <button id="zkRecoverBtn" class="admin-btn">Verify zkPass Identity</button>
                <div id="zkStatus" style="font-size: 0.7rem; margin-top: 5px; font-family: monospace;"></div>

                <hr style="border:0; border-top: 1px solid #eee; margin: 15px 0;">
                
                <h4 style="margin: 0 0 10px 0; color: var(--admin);">Art History Recovery</h4>
                <input type="text" id="recoverAddr" placeholder="Lookup Address (0x...)">
                <button id="recoverArtBtn" class="admin-btn" style="background: var(--success);">Recover On-Chain Art</button>
            </div>

            <div class="card">
                <h4 style="margin:0;">Cluster Logs</h4>
                <div id="txFeed" style="max-height: 200px; overflow-y:auto;"></div>
            </div>
        </div>

        <div class="main-area">
            <div id="artUI" style="display:none; width: 100%; max-width: 600px;">
                <div class="card" style="border-top: 4px solid var(--success);">
                    <h2 style="margin-top: 0;">AI Image Generator</h2>
                    <input type="text" id="promptInput" placeholder="Describe your image (e.g. Cyberpunk Forest)...">
                    <button id="generateBtn" class="primary-btn" style="background: var(--success);">Generate (0.25 LCAI)</button>
                    
                    <div id="displayArea" class="result-window">
                        <span style="color: #666;">AI Art will be rendered here.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ID_ADDR = "0xe0087e581f11b9de0d61697a0cb0cdffca8f1f34";
        const ART_ADDR = "0xd17F12ef2C5d95e135094100a14D3d7569505d89"; // Matches your IDE AIArtStudio deployment
        
        const ABI = [
            "function generateArt(string _prompt) payable",
            "function verifyZkPass(bytes proof)",
            "function isZkVerified(address) view returns (bool)",
            "function latestArt(address) view returns (string)",
            "event ArtCompleted(address indexed user, string imageUrl, bytes32 taskId)"
        ];
        const ID_ABI = ["function getIdentity(address) view returns (string, string, bool)"];

        let signer, contract, idContract, provider;

        function log(msg) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('txFeed').prepend(entry);
        }

        async function connectWallet() {
            if (!window.ethereum) return alert("Please install MetaMask!");
            
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                // EXPLICIT ACCOUNT REQUEST
                await provider.send("eth_requestAccounts", []);
                
                signer = await provider.getSigner();
                const addr = await signer.getAddress();
                
                contract = new ethers.Contract(ART_ADDR, ABI, signer);
                idContract = new ethers.Contract(ID_ADDR, ID_ABI, signer);

                const [id, bal, zkVer] = await Promise.all([
                    idContract.getIdentity(addr),
                    provider.getBalance(addr),
                    contract.isZkVerified(addr)
                ]);

                document.getElementById('tokenBalance').innerText = parseFloat(ethers.formatEther(bal)).toFixed(4);
                document.getElementById('userNameDisplay').innerText = id[0] || "User: " + addr.substring(0,6);
                
                const tag = document.getElementById('verifyTag');
                tag.innerText = id[2] ? "MI-MO VERIFIED" : "ID UNVERIFIED";
                tag.style.background = id[2] ? "#d4edda" : "#f8d7da";
                tag.style.color = id[2] ? "#155724" : "#721c24";

                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('userProfile').style.display = 'block';
                document.getElementById('adminMenu').style.display = 'block';
                document.getElementById('artUI').style.display = 'block';

                log("Wallet Connected: " + addr.substring(0,10));
                if (zkVer) log("zkPass is active");

                // Initialize Callback Listener
                contract.on("ArtCompleted", (user, imageUrl) => {
                    if (user.toLowerCase() === addr.toLowerCase()) {
                        document.getElementById('displayArea').innerHTML = `<img src="${imageUrl}" style="max-width:100%; border-radius:8px;">`;
                        log("AI Art Generated Successfully!");
                    }
                });

            } catch (err) {
                console.error(err);
                alert("Connection failed. Check console for details.");
            }
        }

        // --- ON-CHAIN ART RECOVERY ---
        document.getElementById('recoverArtBtn').onclick = async () => {
            const addr = document.getElementById('recoverAddr').value;
            if (!ethers.isAddress(addr)) return alert("Enter a valid 0x address");
            
            const display = document.getElementById('displayArea');
            display.innerHTML = '<span class="pulsing">Querying Blockchain for history...</span>';
            
            try {
                const url = await contract.latestArt(addr);
                if (!url || url === "") {
                    display.innerHTML = "<span>No previous art found for this address.</span>";
                } else {
                    display.innerHTML = `<img src="${url}" style="max-width:100%; border-radius:8px; border:2px solid #333;">`;
                    log("Art recovered from chain for " + addr.substring(0,6));
                }
            } catch (e) { display.innerHTML = "<span>Error querying chain.</span>"; }
        };

        // --- ZKPASS IDENTITY VERIFICATION ---
        document.getElementById('zkRecoverBtn').onclick = async () => {
            const status = document.getElementById('zkStatus');
            status.innerHTML = "<span class='pulsing'>Generating zkProof...</span>";
            try {
                const proof = ethers.keccak256(ethers.toUtf8Bytes("Lightchain_ZK_" + Date.now()));
                const tx = await contract.verifyZkPass(proof);
                log("zkProof Sent to Lightchain...");
                await tx.wait();
                status.innerHTML = "<span style='color:green;'>zkPass Verified Successfully!</span>";
                log("Identity Recovered via zkPass");
            } catch (e) { status.innerHTML = "<span style='color:red;'>Verification Failed</span>"; }
        };

        // --- GENERATE AI ART ---
        document.getElementById('generateBtn').onclick = async () => {
            const p = document.getElementById('promptInput').value;
            const display = document.getElementById('displayArea');
            if (!p) return alert("Please enter a prompt!");

            try {
                display.innerHTML = '<span class="pulsing">Anchoring to AI Cluster (0.25 LCAI)...</span>';
                const tx = await contract.generateArt(p, { value: ethers.parseEther("0.25") });
                log("Inference Request Sent");
                await tx.wait();
                display.innerHTML = '<span class="pulsing">Request Accepted. Awaiting AIVM Callback...</span>';
            } catch (e) { 
                display.innerHTML = `<span>Error: ${e.reason || "Ensure zkPass is verified first."}</span>`; 
            }
        };

        document.getElementById('connectBtn').onclick = connectWallet;
    </script>
</body>
</html>
