<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AIVM Control Center | Lightchain AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #5865f2; --secondary: #00ff80; --danger: #ff4444; --bg: #0f1016; --card: #1a1b26; --sidebar: #13141f; --border: #2d2f45; --text: #ffffff; --text-dim: #94a3b8; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 60px; background: var(--sidebar); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .header-left-group { display: flex; align-items: center; gap: 15px; }
        .header-title { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .nav-identity-group { display: flex; align-items: center; gap: 10px; margin-left: 10px; padding-left: 15px; border-left: 1px solid var(--border); }
        .nav-sbt-svg { width: 28px; height: 28px; opacity: 0.2; }
        .nav-sbt-svg.active { opacity: 1; filter: drop-shadow(0 0 5px var(--primary)); }
        .nav-desc { font-size: 0.75rem; color: var(--text-dim); }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .btn-nav-connect { background: var(--primary); color: white; border: none; padding: 6px 14px; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 0.8rem; }
        .load-indicator { background: #000; padding: 5px 12px; border-radius: 6px; color: var(--secondary); border: 1px solid #1e293b; font-size: 0.75rem; }
        .wallet-pill { background: #1e293b; padding: 5px 12px; border-radius: 6px; font-family: monospace; border: 1px solid var(--border); font-size: 0.75rem; display: flex; gap: 10px; }
        .balance-txt { color: var(--secondary); font-weight: bold; border-right: 1px solid var(--border); padding-right: 10px; }
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 350px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
        .card-title { font-size: 0.7rem; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 12px; }
        .console { height: 220px; background: #000; border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.75rem; color: #7dd3fc; overflow-y: auto; }
        .admin-input { width: 100%; background: #0f111a; border: 1px solid var(--border); border-radius: 6px; padding: 10px; color: white; margin-bottom: 10px; font-size: 0.75rem; }
        .admin-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-admin { border: none; padding: 6px 8px; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.7rem; }
        .btn-query { grid-column: span 2; background: var(--border); color: white; }
        .btn-verify { background: var(--secondary); color: black; }
        .btn-revoke { background: var(--danger); color: white; }
        .btn-withdraw { width: 100%; background: #f59e0b; color: black; border: none; padding: 8px; border-radius: 6px; font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 0.75rem; }
        .input-group { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; padding: 8px; gap: 10px; }
        .prompt-input { flex: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; font-size: 1rem; }
        .btn-gen { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .output-view { min-height: 400px; background: #08090f; border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-dim); overflow: hidden; position: relative; }
        .mint-overlay { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--secondary); font-size: 0.65rem; color: var(--secondary); display: none; align-items: center; gap: 8px; z-index: 10; }
        .mint-spinner { width: 10px; height: 10px; border: 2px solid var(--secondary); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 10px; }
        .gallery-item { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: 0.2s; position: relative; min-height: 150px; }
        .gallery-img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; cursor: pointer; }
        .gallery-controls { padding: 8px; display: flex; gap: 5px; background: rgba(0,0,0,0.5); }
        .btn-gallery { flex: 1; border: none; padding: 4px; border-radius: 4px; font-size: 0.6rem; font-weight: 700; cursor: pointer; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <header>
        <div class="header-left-group">
            <div class="header-title">AIVM Control Center</div>
            <button class="btn-nav-connect" id="connect-btn">Connect Wallet</button>
            <div class="nav-identity-group">
                <div id="sbt-svg-container" class="nav-sbt-svg"></div>
                <span id="nav-id-desc" class="nav-desc">Identity Offline</span>
            </div>
        </div>
        <div class="header-right">
            <div class="load-indicator">‚óè SDXL-Turbo | Load: 21%</div>
            <div class="wallet-pill">
                <span id="balance-display" class="balance-txt">0.00 LCAI</span>
                <span id="address-display">0x00...00</span>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="sidebar">
            <div class="card"><div class="card-title">System Status Window</div><div id="console-output" class="console"></div></div>
            <div class="card">
                <div class="card-title">Admin Management</div>
                <input type="text" id="admin-user-addr" class="admin-input" placeholder="0x...">
                <div class="admin-actions">
                    <button class="btn-admin btn-query" id="admin-query">Query Status</button>
                    <button class="btn-admin btn-verify" id="admin-verify">Verify</button>
                    <button class="btn-admin btn-revoke" id="admin-revoke">Revoke</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title">Owner Vault</div>
                <div style="font-size: 0.65rem; color: var(--text-dim);">Revenue Collected:</div>
                <div id="revenue-display" style="font-size: 1.2rem; font-weight: 800; color: var(--secondary); margin: 2px 0;">0.00 LCAI</div>
                <button id="withdraw-btn" class="btn-withdraw">Withdraw Funds</button>
            </div>
        </div>
        <div class="main-content">
            <div class="input-group">
                <input type="text" id="prompt-input" class="prompt-input" placeholder="Describe the art you wish to generate...">
                <button id="generate-btn" class="btn-gen">Generate (0.25 LCAI)</button>
            </div>
            <div class="output-view" id="art-output">
                <div id="mint-status" class="mint-overlay"><div class="mint-spinner"></div>Status: Minting...</div>
                Awaiting AIVM Inference Signal...
            </div>
            <div class="card">
                <div class="card-title">Previous Art History</div>
                <div id="art-gallery" class="gallery-grid"></div>
            </div>
        </div>
    </div>
    <script>
        // Updated to use your latest Deployed Contract Addresses
        const CONFIG = { 
            SBT_ADDR: "0xd71462F0002Ee9373fCe05B568583Ed13e75f600", 
            AIVM_ADDR: "0xbcA38515887Dc3Ca163398C0Ef7bF02dd156D8FB" 
        };

        const ABI = [
            "function hasSBT(address) view returns (bool)", 
            "function isAdmin(address) view returns (bool)", 
            "function owner() view returns (address)", 
            "function setVerification(address,bool) external", 
            "function generateArt(string) external payable", 
            "function withdraw() external", 
            "event ArtGenerated(address indexed,string,bytes32,uint256)" 
        ];

        let provider, signer, userAddr, sbtContract, studioContract;
        const sbtSvg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" fill="none" stroke="#5865f2" stroke-width="5"/><path d="M30 50L45 65L70 35" stroke="#00ff80" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

        function log(m, e) { const out = document.getElementById('console-output'); const div = document.createElement('div'); div.style.color = e ? "#ff4444" : "#7dd3fc"; div.innerText = `> ${m}`; out.appendChild(div); out.scrollTop = out.scrollHeight; }
        
        async function updateVault() { 
            if (!provider) return; 
            const bal = await provider.getBalance(CONFIG.AIVM_ADDR); 
            document.getElementById('revenue-display').innerText = `${parseFloat(ethers.formatEther(bal)).toFixed(2)} LCAI`; 
        }
        
        async function connect() {
            if (!window.ethereum) return log("MetaMask not found", true);
            try {
                // Explicit version for ethers v6 connection
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddr = accounts[0];
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                sbtContract = new ethers.Contract(CONFIG.SBT_ADDR, ABI, signer);
                studioContract = new ethers.Contract(CONFIG.AIVM_ADDR, ABI, signer);

                document.getElementById('address-display').innerText = `${userAddr.slice(0,6)}...${userAddr.slice(-4)}`;
                const bal = await provider.getBalance(userAddr);
                document.getElementById('balance-display').innerText = `${parseFloat(ethers.formatEther(bal)).toFixed(2)} LCAI`;
                document.getElementById('connect-btn').innerText = "Wallet Linked";

                // Native LCAI AIVM V2 Event Listener
                studioContract.on("ArtGenerated", (u, p, digest, fee) => { 
                    log("AIVM Signal Received. Pulling from Native Gateway...");
                    document.getElementById('mint-status').style.display = 'none';
                    updateVault(); 
                    renderArt(p); 
                });

                log(`Authenticated: ${userAddr}`); 
                checkIdentity(); 
                updateVault(); 
                scanHistory(); 
            } catch (err) { 
                log("Connection failed.", true); 
                console.error(err);
            }
        }

        async function scanHistory() {
            try {
                log("Scanning Native AIVM History...");
                const filter = studioContract.filters.ArtGenerated();
                const events = await studioContract.queryFilter(filter, -10000);
                const gallery = document.getElementById('art-gallery');
                gallery.innerHTML = ''; 
                events.slice(-10).reverse().forEach(ev => { addToGallery(ev.args[1]); });
                log(`History Sync: ${events.length > 10 ? 10 : events.length} items recovered.`);
            } catch (e) { log("Native Scan Failed.", true); }
        }

        const GATEWAYS = [
            "https://api.lightchain.ai/v1/aivm/render/",
            "https://gateway.lightchain.ai/ipfs/"
        ];

        function addToGallery(p) {
            const gallery = document.getElementById('art-gallery');
            const item = document.createElement('div');
            item.className = 'gallery-item';
            const seed = Math.floor(Math.random()*99999);
            const promptEncoded = encodeURIComponent(p);
            const url = `${GATEWAYS[0]}${promptEncoded}?width=512&height=512&nologo=true&seed=${seed}`;
            
            item.innerHTML = `
                <div class="sync-status" style="height:150px; display:flex; align-items:center; justify-content:center; background:#000; font-size:0.6rem; color:var(--primary); animation:pulse 1s infinite">Syncing...</div>
                <img src="${url}" class="gallery-img" style="display:none" 
                     onload="this.style.display='block'; this.previousElementSibling.style.display='none'; this.nextElementSibling.style.display='flex';"
                     onerror="this.src='https://image.pollinations.ai/prompt/${promptEncoded}?width=512&height=512&nologo=true';">
                <div class="gallery-controls" style="display:none">
                    <button class="btn-gallery" style="background:var(--primary);color:white" onclick="window.swapToMain('${url}')">View</button>
                    <button class="btn-gallery" style="background:var(--secondary);color:black" onclick="window.downloadImg('${url}')">DL</button>
                </div>`;
            gallery.appendChild(item);
        }

        function renderArt(p) {
            const out = document.getElementById('art-output');
            out.innerHTML = `<div id="mint-status" class="mint-overlay" style="display:flex"><div class="mint-spinner"></div>Status: Manifesting Pixels...</div><div style="color:var(--primary); font-weight:bold; animation:pulse 1.5s infinite">AIVM Inference in Progress...</div>`;
            
            const promptEncoded = encodeURIComponent(p);
            const url = `${GATEWAYS[0]}${promptEncoded}?width=1024&height=1024&nologo=true&seed=${Date.now()}`;
            
            const img = new Image();
            img.src = url;
            img.onload = () => {
                out.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:contain;">`;
                addToGallery(p);
                log("AIVM manifest complete.");
            };
            img.onerror = () => {
                log("Primary Node Busy. Switching to Mirror...", false);
                const fallbackUrl = `https://image.pollinations.ai/prompt/${promptEncoded}?width=1024&height=1024&nologo=true&seed=${Date.now()}`;
                out.innerHTML = `<img src="${fallbackUrl}" style="width:100%; height:100%; object-fit:contain;">`;
                addToGallery(p);
            };
        }

        async function checkIdentity() {
            try {
                const isA = await sbtContract.isAdmin(userAddr);
                const o = await studioContract.owner();
                if (isA || userAddr.toLowerCase() === o.toLowerCase()) {
                    document.getElementById('sbt-svg-container').innerHTML = sbtSvg;
                    document.getElementById('nav-id-desc').innerText = (userAddr.toLowerCase() === o.toLowerCase()) ? "Contract Owner Verified" : "Master Admin Verified";
                    document.getElementById('sbt-svg-container').classList.add('active');
                }
            } catch (e) {}
        }

        window.swapToMain = (url) => { document.getElementById('art-output').innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:contain;">`; };
        window.downloadImg = async (url) => { const a = document.createElement('a'); a.href = url; a.download = `AIVM_${Date.now()}.jpg`; a.click(); };
        
        document.getElementById('admin-query').onclick = async () => { 
            const a = document.getElementById('admin-user-addr').value; 
            if (!ethers.isAddress(a)) return log("Invalid Address", true); 
            log(`Querying: SBT=${await sbtContract.hasSBT(a)} | Admin=${await sbtContract.isAdmin(a)}`); 
        };
        
        document.getElementById('admin-verify').onclick = async () => { 
            try { 
                const tx = await studioContract.setVerification(document.getElementById('admin-user-addr').value, true); 
                await tx.wait();
                log("Verified!"); 
            } catch (e) { log("Denied", true); } 
        };
        
        document.getElementById('withdraw-btn').onclick = async () => { 
            try { 
                const tx = await studioContract.withdraw(); 
                await tx.wait();
                log("Withdrawn!"); 
                updateVault(); 
            } catch (e) { log("Denied", true); } 
        };
        
        document.getElementById('generate-btn').onclick = async () => {
            const p = document.getElementById('prompt-input').value;
            if(!p) return log("Enter a prompt", true);
            try { 
                document.getElementById('mint-status').style.display = 'flex'; 
                log("Anchoring Inference to Lightchain...");
                const tx = await studioContract.generateArt(p, { value: ethers.parseEther("0.25") });
                log("Transaction broadcast. Waiting for PoI Attestation...");
                await tx.wait(); 
                log("Blockchain anchoring successful.");
            } catch (e) { 
                log("Failed", true); 
                document.getElementById('mint-status').style.display = 'none'; 
            }
        };

        document.getElementById('connect-btn').onclick = connect;
        log("System Online. Awaiting Handshake...");
    </script>
</body>
</html>
