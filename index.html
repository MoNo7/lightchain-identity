<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | IAM Control Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { 
            --accent: #0070ff; 
            --bg: #020408; 
            --panel: #0b0e14; 
            --border: #1e2633; 
            --text-dim: #6a768a;
        }

        body { margin: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* --- RELEASE SIDEBAR --- */
        nav { 
            width: 260px; 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            padding: 30px; 
            background: var(--panel); 
        }

        .status-terminal { 
            background: rgba(0, 112, 255, 0.03); 
            border: 1px solid var(--border); 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 30px; 
            font-family: monospace;
            font-size: 0.65rem; 
        }

        .dot { height: 7px; width: 7px; background: #333; border-radius: 50%; display: inline-block; margin-right: 8px; transition: 0.3s; }
        .dot.online { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        .nav-logo { font-weight: 900; letter-spacing: 2px; color: var(--accent); margin-bottom: 45px; font-size: 1.1rem; }
        .nav-logo span { color: white; }

        .nav-link { 
            color: var(--text-dim); 
            padding: 14px; 
            cursor: pointer; 
            border-radius: 6px; 
            margin-bottom: 8px; 
            transition: 0.2s; 
            border: none; 
            background: none; 
            text-align: left; 
            font-size: 0.8rem; 
            font-family: monospace;
        }

        .nav-link:hover, .nav-link.active { color: white; background: var(--accent); }
        .nav-link.locked { opacity: 0.2; cursor: not-allowed; }

        /* --- MAIN VIEW --- */
        .viewport { flex: 1; display: flex; flex-direction: column; }
        header { 
            height: 80px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            padding: 0 40px; 
            gap: 15px; 
        }

        /* --- PILLS (Merged) --- */
        .cluster-pill { 
            display: flex; 
            align-items: center; 
            background: #000; 
            border: 1px solid var(--border); 
            border-radius: 50px; 
            padding: 7px 18px; 
            font-size: 0.7rem; 
            color: var(--accent); 
            font-family: monospace;
        }

        .wallet-pill { 
            background: var(--accent); 
            color: white; 
            border-radius: 50px; 
            padding: 9px 22px; 
            font-weight: 900; 
            cursor: pointer; 
            border: none; 
            font-size: 0.75rem; 
            transition: 0.2s;
        }

        /* --- CONTENT --- */
        .page { flex: 1; padding: 50px; display: none; overflow-y: auto; }
        .page.active { display: block; }
        .card { background: var(--panel); border: 1px solid var(--border); padding: 40px; border-radius: 12px; max-width: 600px; border-top: 4px solid var(--accent); }
        pre { background: #05070a; padding: 20px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.75rem; color: var(--text-dim); overflow-x: auto; margin: 20px 0; }
        #qr-code { background: white; padding: 12px; display: inline-block; border-radius: 8px; margin-top: 20px; cursor: pointer; }
    </style>
</head>
<body>

<nav>
    <div class="status-terminal">
        <div><span class="dot online"></span> NETWORK: LIGHTCHAIN-V2</div>
        <div style="margin-top:5px;"><span id="aivm-dot" class="dot"></span> AIVM: <span id="aivm-stat">STANDBY</span></div>
    </div>
    
    <div class="nav-logo">LCAI <span>IAM</span></div>
    
    <button class="nav-link active" onclick="setView('id-view')">ZK IDENTITY</button>
    <button class="nav-link" onclick="setView('rec-view')">IDENTITY RECOVERY</button>
    <button id="aivm-link" class="nav-link locked" onclick="setView('gen-view')">AIVM GENERATOR</button>
</nav>

<div class="viewport">
    <header>
        <div class="cluster-pill">
            <span style="opacity:0.4; margin-right:12px;">AIVM-THETA</span>
            <span id="load-txt" style="font-weight:800; margin-right:12px; min-width:60px;">LOAD: 0%</span>
            <span id="stat-txt" style="font-weight:800; color:#fff; background:#1e2633; padding:2px 8px; border-radius:4px;">IDLE</span>
        </div>
        <button id="wallet-btn" class="wallet-pill" onclick="handleWallet()">CONNECT WALLET</button>
    </header>

    <div id="id-view" class="page active">
        <div class="card">
            <h2 style="margin:0;">ZK-IDENTITY TOKEN</h2>
            <p style="color:var(--text-dim); font-size:0.9rem;">Your secure Soulbound credentials and QR Access Key.</p>
            <pre id="json-box">{ "status": "awaiting_connection" }</pre>
            <button onclick="dlJSON()" style="background:none; border:1px solid #333; color:var(--text-dim); padding:6px 12px; border-radius:4px; cursor:pointer; font-size:0.7rem;">DOWNLOAD JSON</button>
            <br><br>
            <div id="qr-code" onclick="dlQR()"></div>
            <p style="font-size:0.6rem; color:#444; margin-top:10px;">Click QR Code to download as PNG</p>
        </div>
    </div>

    <div id="rec-view" class="page">
        <div class="card" style="border-top-color:#333;">
            <h2>ADMIN RECOVERY</h2>
            <p style="color:var(--text-dim);">Identity recovery and owner administrative controls.</p>
            <button class="nav-link" style="border:1px solid var(--border); width:100%; margin-top:20px;">Trigger Recovery Protocol</button>
        </div>
    </div>

    <div id="gen-view" class="page" style="padding:0;">
        <iframe id="gen-iframe" src="artgenerator-ui.html" style="width:100%; height:100%; border:none;"></iframe>
    </div>
</div>

<script>
let account = "";
function setView(id) {
    if(id === 'gen-view' && !account) return;
    document.querySelectorAll('.page, .nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
}

async function handleWallet() {
    if(!window.ethereum) return;
    const provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await provider.send("eth_requestAccounts", []);
    account = accounts[0];
    
    // UI Update
    const btn = document.getElementById('wallet-btn');
    btn.innerText = account.slice(0,6).toUpperCase() + "..." + account.slice(-4).toUpperCase();
    btn.onclick = async () => {
        await navigator.clipboard.writeText(account);
        btn.innerText = "COPIED!";
        setTimeout(() => { btn.innerText = account.slice(0,6).toUpperCase() + "..." + account.slice(-4).toUpperCase(); }, 1000);
    };

    // Identity Reveal
    const idData = { address: account, network: "LCAI-AIVM", timestamp: new Date().toISOString() };
    document.getElementById('json-box').innerText = JSON.stringify(idData, null, 4);
    
    // QR Reveal
    document.getElementById('qr-code').innerHTML = "";
    new QRCode(document.getElementById("qr-code"), { text: account, width: 140, height: 140 });

    // Unlock
    document.getElementById('aivm-link').classList.remove('locked');
    document.getElementById('aivm-dot').classList.add('online');
    document.getElementById('aivm-stat').innerText = "ACTIVE";
    document.getElementById('aivm-stat').style.color = "var(--accent)";
}

function dlJSON() {
    const blob = new Blob([document.getElementById('json-box').innerText], {type:"application/json"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download="id.json"; a.click();
}

function dlQR() {
    const canvas = document.querySelector('#qr-code canvas');
    const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download="id_qr.png"; a.click();
}

window.addEventListener('message', (e) => {
    if(e.data.type === 'AIVM_METRICS') {
        document.getElementById('load-txt').innerText = `LOAD: ${e.data.load}%`;
        const st = document.getElementById('stat-txt');
        st.innerText = e.data.status.toUpperCase();
        st.style.color = e.data.status === 'mining' ? '#ffcc00' : (e.data.status === 'error' ? '#ff4444' : '#fff');
    }
});
</script>
</body>
</html>
