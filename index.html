<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | IAM Control Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --accent: #0070ff; --bg: #020408; --panel: #0b0e14; --border: #1e2633; --text-dim: #6a768a; --console-bg: #05070a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        nav { width: 280px; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 25px; background: var(--panel); box-sizing: border-box; }
        .nav-logo { font-weight: 900; letter-spacing: 2px; color: var(--accent); margin-bottom: 25px; font-size: 1.1rem; text-align: center; }
        .system-console { background: var(--console-bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.65rem; height: 180px; overflow-y: auto; margin-bottom: 20px; color: #4e5d75; line-height: 1.5; }
        .console-line { margin-bottom: 4px; border-left: 2px solid #1a202c; padding-left: 8px; }
        .console-line.success { border-left-color: var(--accent); color: #fff; }
        .console-line.error { border-left-color: #ff4444; color: #ff4444; }
        .nav-menu { display: flex; flex-direction: column; gap: 5px; }
        .nav-link { color: var(--text-dim); padding: 12px 15px; cursor: pointer; border-radius: 6px; border: none; background: none; text-align: left; font-size: 0.75rem; font-family: monospace; width: 100%; font-weight: 600; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { color: white; background: var(--accent); }
        .viewport { flex: 1; display: flex; flex-direction: column; }
        header { height: 80px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-sizing: border-box; }
        .pill { background: #000; border: 1px solid var(--border); border-radius: 50px; padding: 7px 20px; font-size: 0.7rem; color: var(--accent); font-family: monospace; display: flex; align-items: center; gap: 8px; }
        .wallet-pill { background: var(--accent); color: white; border-radius: 50px; padding: 9px 24px; font-weight: 900; cursor: pointer; border: none; font-size: 0.75rem; font-family: monospace; letter-spacing: 1px; }
        .view-pane { flex: 1; padding: 45px; display: none; overflow-y: auto; }
        .view-pane.active { display: block !important; }
        .card { background: var(--panel); border: 1px solid var(--border); padding: 35px; border-radius: 12px; max-width: 750px; border-top: 4px solid var(--accent); margin-bottom: 20px; }
        .panel-input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 4px; font-size: 0.75rem; margin-bottom: 12px; box-sizing: border-box; font-family: monospace; }
        .action-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; width: 100%; font-weight: bold; }
        .action-btn.alt { background: transparent; border: 1px solid var(--accent); color: var(--accent); margin-top: 8px; }
        .status-table { width: 100%; font-size: 0.7rem; border-collapse: collapse; margin-top: 15px; font-family: monospace; }
        .status-table td, .status-table th { border: 1px solid var(--border); padding: 8px; text-align: left; }
        .status-online { color: #00c853; }
        .status-checking { color: var(--text-dim); }
    </style>
</head>
<body>

<nav>
    <div class="nav-logo">LCAI <span>IAM</span></div>
    <div class="system-console" id="console"><div class="console-line">>> KERNEL_READY</div></div>
    <div id="side-menu" class="nav-menu">
        <button class="nav-link active" onclick="showView('gallery-view', this); initGallery();">NETWORK GALLERY</button>
    </div>
</nav>

<div class="viewport">
    <header>
        <div class="pill">MODEL: <span id="active-model">AIVM-THETA</span> | <span id="status-txt">IDLE</span></div>
        <div class="header-right"><button id="wallet-btn" class="wallet-pill" onclick="connectWallet()">CONNECT WALLET</button></div>
    </header>

    <div id="gallery-view" class="view-pane active">
        <div class="card" style="max-width: 900px;">
            <h2>NETWORK GALLERY</h2>
            <div id="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px;"></div>
        </div>
    </div>

    <div id="id-view" class="view-pane">
        <div class="card">
            <h2>ZK-SBT IDENTITY CARD</h2>
            <pre id="id-json" onclick="saveJSON()">// Identity Packet Offline</pre>
            <div id="qr-target" onclick="saveQR()" style="margin-top:20px; background:white; padding:10px; display:none; border-radius:4px; cursor:pointer;"></div>
        </div>
    </div>

    <div id="admin-view" class="view-pane">
        <div class="card">
            <h2>ADMIN & LIVE TELEMETRY</h2>
            <input type="text" class="panel-input" id="admin-addr" placeholder="Target Operator Address (0x...)">
            <button class="action-btn" onclick="runAdmin('query')">QUERY USER STATUS</button>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="action-btn alt" onclick="runAdmin('verify')" style="flex:1">VERIFY USER</button>
                <button class="action-btn alt" onclick="runAdmin('revoke')" style="flex:1; border-color:#ff4444; color:#ff4444;">REVOKE USER</button>
            </div>
            
            <h3 style="margin-top:30px; font-size:0.9rem;">MODEL LIVE PROBE</h3>
            <table class="status-table">
                <thead><tr><th>MODEL</th><th>DIGEST</th><th>STATE</th></tr></thead>
                <tbody id="telemetry-body">
                    <tr><td>THETA</td><td>0x2bf0...</td><td id="stat-theta" class="status-checking">WAITING...</td></tr>
                    <tr><td>DELTA</td><td>0x4a8c...</td><td id="stat-delta" class="status-checking">WAITING...</td></tr>
                    <tr><td>SIGMA</td><td>0x6f63...</td><td id="stat-sigma" class="status-checking">WAITING...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="treasury-view" class="view-pane">
        <div class="card">
            <h2>TREASURY VAULT</h2>
            <div style="background:#000; padding:25px; border-radius:8px; margin-bottom:20px; border:1px solid var(--border); text-align:center;">
                <div id="revenue-val" style="font-size:2rem; color:var(--accent); font-weight:900;">0.00 tLCAI</div>
            </div>
            <button class="action-btn" onclick="runOwner()">WITHDRAW ALL FUNDS</button>
        </div>
    </div>

    <div id="aivm-view" class="view-pane">
        <div class="card">
            <h2>AIVM INFERENCE</h2>
            <select id="model-select" class="panel-input" onchange="document.getElementById('active-model').innerText=this.value">
                <option value="AIVM-THETA" data-hash="0x2bf0539500000000000000000000000000000000000000000000000000000000">AIVM-THETA (Standard)</option>
                <option value="AIVM-DELTA" data-hash="0x4a8c30d500000000000000000000000000000000000000000000000000000000">AIVM-DELTA (High Speed)</option>
                <option value="AIVM-SIGMA" data-hash="0x6f63a19b3cf48600000000000000000000000000000000000000000000000000">AIVM-SIGMA (Neural)</option>
            </select>
            <textarea id="art-prompt" class="panel-input" placeholder="Neural landscape..." style="height:120px;"></textarea>
            <button class="action-btn" onclick="generateArt()">REQUEST INFERENCE (0.25 tLCAI)</button>
        </div>
    </div>
</div>

<script>
const CONFIG = {
    addr: "0x5B2d46cb1e3451aA3d584f28E714892373D7c7C6",
    abi: [
        "function owner() public view returns (address)",
        "function setVerification(address user, bool status) external",
        "function withdraw() external",
        "function manualVerified(address) public view returns (bool)",
        "function generateArt(string prompt, bytes32 modelDigest) public payable",
        "event InferenceRequested(address indexed user, string prompt)"
    ]
};

let user, provider, signer, contract, roles = { isOwner: false, isVerified: false };

const log = (msg, type = "info") => {
    const cb = document.getElementById('console');
    const l = document.createElement('div');
    l.className = `console-line ${type === 'success' ? 'success' : type === 'error' ? 'error' : ''}`;
    l.innerText = `>> ${msg}`;
    cb.appendChild(l);
    cb.scrollTop = cb.scrollHeight;
};

async function connectWallet() {
    if (!window.ethereum) return log("METAMASK MISSING", "error");
    try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        user = accounts[0];
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONFIG.addr, CONFIG.abi, signer);
        
        const ownerAddr = await contract.owner();
        roles.isOwner = (user.toLowerCase() === ownerAddr.toLowerCase());
        roles.isVerified = await contract.manualVerified(user);

        log(`STREAK_SYNC: ${user.slice(0, 10)}`, "success");
        updateMenu();
        updateIdentity();
        initGallery();
        refreshBalance();
        updateWalletPill();
        probeModels(); 
    } catch (e) { log("HANDSHAKE FAILED", "error"); }
}

async function probeModels() {
    const hashes = {
        theta: "0x2bf0539500000000000000000000000000000000000000000000000000000000",
        delta: "0x4a8c30d500000000000000000000000000000000000000000000000000000000",
        sigma: "0x6f63a19b3cf48600000000000000000000000000000000000000000000000000"
    };

    for (let m in hashes) {
        const el = document.getElementById(`stat-${m}`);
        try {
            await contract.generateArt.staticCall("probe", hashes[m], { value: ethers.parseEther("0.25") });
            el.innerText = "ACTIVE"; el.className = "status-online";
        } catch (e) {
            el.innerText = "LOCKED/REVERT"; el.style.color = "#ff4444";
        }
    }
}

async function generateArt() {
    const prompt = document.getElementById('art-prompt').value;
    const sel = document.getElementById('model-select');
    const modelHash = sel.options[sel.selectedIndex].getAttribute('data-hash');
    const fee = ethers.parseEther("0.25");

    try {
        log("PRE-FLIGHT CHECK...");
        const isActuallyVerified = await contract.manualVerified(user);
        if(!isActuallyVerified) {
            log("REVERT: ADDRESS NOT WHITELISTED", "error");
            log("VERIFICATION TX MAY BE PENDING", "info");
            return;
        }

        document.getElementById('status-txt').innerText = "PENDING";
        const tx = await contract.generateArt(prompt, modelHash, { value: fee, gasLimit: 3000000 });
        log("TX BROADCASTED", "success");
        await tx.wait();
        log("INFERENCE SUCCESSFUL", "success");
        initGallery();
    } catch (e) {
        log("REJECTED: CONTRACT REVERTED", "error");
        document.getElementById('status-txt').innerText = "ERROR";
    }
}

async function runAdmin(type) {
    const target = document.getElementById('admin-addr').value;
    if(!target) return log("INPUT REQUIRED", "error");
    try {
        if(type === 'query') {
            const res = await contract.manualVerified(target);
            log(`USER ${target.slice(0, 6)}: ${res ? "VERIFIED" : "UNVERIFIED"}`);
        } else {
            log("SYNCING PERMISSIONS...");
            const tx = await contract.setVerification(target, type === 'verify', { gasLimit: 200000 });
            await tx.wait(); log("PERMISSION SYNCED", "success");
            roles.isVerified = (type === 'verify'); 
            updateMenu();
            probeModels(); // Re-probe after verification
        }
    } catch (e) { log("ADMIN ACTION REVERTED", "error"); }
}

async function updateWalletPill() {
    if(!user || !provider) return;
    const bal = await provider.getBalance(user);
    document.getElementById('wallet-btn').innerText = `${user.slice(0, 6).toUpperCase()} | ${ethers.formatEther(bal).slice(0, 6)} LCAI`;
}

function updateMenu() {
    const menu = document.getElementById('side-menu');
    let html = `<button class="nav-link active" onclick="showView('gallery-view', this); initGallery();">NETWORK GALLERY</button>`;
    if(user) {
        html += `<button class="nav-link" onclick="showView('id-view', this)">ZK IDENTITY</button>`;
        if(roles.isOwner) {
            html += `<button class="nav-link" onclick="showView('admin-view', this)">ADMIN PANEL</button>`;
            html += `<button class="nav-link" onclick="showView('treasury-view', this)">TREASURY VAULT</button>`;
        }
        if(roles.isVerified || roles.isOwner) {
            html += `<button class="nav-link" onclick="showView('aivm-view', this)">LCAI AIVM ART</button>`;
        }
    }
    menu.innerHTML = html;
}

function updateIdentity() {
    const idData = {
        "identity": {
            "operator_id": `LCAI-${user.slice(2, 8).toUpperCase()}`,
            "role": roles.isOwner ? "SYSTEM_OWNER" : (roles.isVerified ? "VERIFIED_OPERATOR" : "GUEST_NODE"),
            "access_tier": roles.isOwner ? "OMEGA" : (roles.isVerified ? "STANDARD" : "LIMITED"),
            "auth_method": "ZK_SBT_HANDSHAKE",
            "timestamp": Math.floor(Date.now() / 1000)
        }
    };
    document.getElementById('id-json').innerText = JSON.stringify(idData, null, 4);
    document.getElementById('qr-target').style.display = "inline-block";
    document.getElementById('qr-target').innerHTML = "";
    new QRCode(document.getElementById("qr-target"), { text: JSON.stringify(idData), width: 140, height: 140 });
}

async function initGallery() {
    if(!contract) return;
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = "SCANNING...";
    try {
        const events = await contract.queryFilter("InferenceRequested", -50000);
        grid.innerHTML = events.length === 0 ? "EMPTY" : "";
        events.reverse().forEach(ev => {
            grid.innerHTML += `<div style="background:#000; padding:10px; border-radius:6px; border:1px solid var(--border);"><img src="https://picsum.photos/seed/${ev.transactionHash}/200/150" style="width:100%; border-radius:4px;"></div>`;
        });
    } catch (e) { grid.innerHTML = "OFFLINE"; }
}

async function runOwner() {
    try {
        const tx = await contract.withdraw({ gasLimit: 200000 });
        await tx.wait(); log("VAULT WITHDRAWN", "success");
        refreshBalance();
    } catch (e) { log("WITHDRAWAL FAILED", "error"); }
}

async function refreshBalance() {
    if(!provider) return;
    const bal = await provider.getBalance(CONFIG.addr);
    document.getElementById('revenue-val').innerText = `${ethers.formatEther(bal).slice(0, 6)} tLCAI`;
}

function showView(id, btn) {
    document.querySelectorAll('.view-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

function saveJSON() {
    const data = document.getElementById('id-json').innerText;
    const b = new Blob([data], {type: "application/json"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `LCAI_ID_${user.slice(0, 6)}.json`; a.click();
}

function saveQR() {
    const qrImg = document.querySelector('#qr-target img');
    if(!qrImg) return;
    const link = document.createElement('a');
    link.href = qrImg.src;
    link.download = `LCAI_QR_${user.slice(0, 6)}.png`;
    link.click();
}

initGallery();
</script>
</body>
</html>
