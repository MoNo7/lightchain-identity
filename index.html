<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --neon: #00ff80; --bg: #050505; --panel: #0a0a0a; --border: #222; }
        body { margin: 0; background: var(--bg); color: white; font-family: monospace; display: flex; height: 100vh; }
        
        /* Sidebar */
        nav { width: 240px; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 25px; background: var(--panel); }
        .logo { font-weight: 900; color: var(--neon); margin-bottom: 40px; font-size: 1.2rem; }
        .menu-btn { color: #666; padding: 12px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; transition: 0.2s; border: none; background: none; text-align: left; font-family: monospace; }
        .menu-btn:hover, .menu-btn.active { color: var(--neon); background: rgba(0,255,128,0.05); }
        .hidden { display: none !important; }

        /* Main Area */
        .viewport { flex: 1; display: flex; flex-direction: column; }
        header { height: 70px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: flex-end; padding: 0 30px; gap: 15px; }
        
        /* Identity & Admin Panels */
        .view-frame { flex: 1; padding: 40px; display: none; overflow-y: auto; }
        .view-frame.active { display: block; }
        .card { background: var(--panel); border: 1px solid var(--border); padding: 30px; border-radius: 12px; max-width: 600px; }
        #qrcode { background: white; padding: 10px; display: inline-block; margin-top: 20px; cursor: pointer; }
        
        /* Status Pills */
        .pill { background: #000; border: 1px solid #333; border-radius: 50px; padding: 6px 15px; font-size: 0.7rem; color: var(--neon); }
        .wallet-pill { background: var(--neon); color: #000; border-radius: 50px; padding: 7px 20px; font-weight: 900; cursor: pointer; border: none; }
    </style>
</head>
<body>

<nav>
    <div class="logo">LIGHTCHAIN <span>AIVM</span></div>
    <div class="menu-items">
        <button class="menu-btn active" onclick="showView('identity-view')">ZK IDENTITY</button>
        <button class="menu-btn" onclick="showView('recovery-view')">RECOVERY & ADMIN</button>
        <button id="aivm-nav" class="menu-btn hidden" onclick="showView('aivm-view')">AIVM GENERATOR</button>
    </div>
</nav>

<div class="viewport">
    <header>
        <div class="pill">AIVM-THETA | <span id="l-val">0%</span> | <span id="s-val">IDLE</span></div>
        <button id="w-btn" class="wallet-pill" onclick="initConnect()">CONNECT</button>
    </header>

    <div id="identity-view" class="view-frame active">
        <div class="card">
            <h2 style="color:var(--neon)">ZK IDENTITY</h2>
            <p style="color:#888; font-size:0.8rem;">Download your secure identity JSON and QR code below.</p>
            <pre id="zk-json" style="background:#000; padding:15px; border:1px solid #222; font-size:0.7rem; overflow:auto;"></pre>
            <button class="wallet-pill" style="font-size:0.6rem" onclick="downloadJSON()">DOWNLOAD JSON</button>
            <br><br>
            <div id="qrcode" onclick="downloadQR()"></div>
            <p style="font-size:0.6rem; color:#555; margin-top:10px;">Click QR to download PNG</p>
        </div>
    </div>

    <div id="recovery-view" class="view-frame">
        <div class="card">
            <h2 style="color:var(--neon)">ADMIN & RECOVERY</h2>
            <div style="border-bottom: 1px solid #222; margin-bottom:20px; padding-bottom:10px;">
                <h4>OWNER PANEL</h4>
                <button class="menu-btn" style="border:1px solid #333">Trigger Recovery</button>
            </div>
            <h4>ADMIN PANEL</h4>
            <p style="font-size:0.8rem; color:#666">Manage smart contract state and AIVM nodes.</p>
        </div>
    </div>

    <div id="aivm-view" class="view-frame" style="padding:0;">
        <iframe src="artgenerator-ui.html" style="width:100%; height:100%; border:none;"></iframe>
    </div>
</div>

<script>
let state = { address: "", verified: false };

function showView(id) {
    document.querySelectorAll('.view-frame').forEach(f => f.classList.remove('active'));
    document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.currentTarget.classList.add('active');
}

async function initConnect() {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const acc = await provider.send("eth_requestAccounts", []);
    state.address = acc[0];
    
    // UI Updates
    document.getElementById('w-btn').innerText = acc[0].slice(0,6).toUpperCase();
    
    // Generate ZK Mock Data for JSON/QR
    const zkData = { id: acc[0], network: "Lightchain-AIVM", timestamp: Date.now() };
    document.getElementById('zk-json').innerText = JSON.stringify(zkData, null, 2);
    
    // Restore QR Code
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById("qrcode"), { text: acc[0], width: 128, height: 128 });

    // UNLOCK AIVM (Simulation of verification check)
    setTimeout(() => {
        document.getElementById('aivm-nav').classList.remove('hidden');
        state.verified = true;
    }, 1000);
}

function downloadJSON() {
    const data = document.getElementById('zk-json').innerText;
    const blob = new Blob([data], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "lcai_identity.json"; a.click();
}

function downloadQR() {
    const canvas = document.querySelector('#qrcode canvas');
    const image = canvas.toDataURL("image/png");
    const a = document.createElement('a');
    a.href = image; a.download = "lcai_qr.png"; a.click();
}

window.addEventListener('message', (e) => {
    if (e.data.type === 'AIVM_METRICS') {
        document.getElementById('l-val').innerText = e.data.load + "%";
        document.getElementById('s-val').innerText = e.data.status.toUpperCase();
    }
});
</script>
</body>
</html>
