<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI Identity Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #007bff;
            --admin: #dc3545;
            --bg: #f0f2f5;
            --text: #1c1e21;
            --success: #28a745;
            --mimo: #1877F2;
            --owner: #6f42c1;
            --warning: #f0ad4e;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        #topNav {
            height: 60px;
            background: #fff;
            border-bottom: 1px solid #e1e4e8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            flex-shrink: 0;
        }
        .nav-title h1 {
            font-size: 1.1rem;
            color: #0056b3;
            margin: 0;
        }
        .token-display {
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #e1e4e8;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--success);
        }
        .content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
        }
        #leftSidebar, #rightSidebar {
            width: 320px;
            min-width: 320px;
            max-width: 320px;
            background: #fff;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e1e4e8;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        #rightSidebar {
            border-right: none;
            border-left: 1px solid #e1e4e8;
        }
        .main-utility-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f8f9fa;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid #e1e4e8;
            width: 100%;
            box-sizing: border-box;
        }
        .primary-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            margin-top: 10px;
            transition: 0.2s;
        }
        .small-btn {
            padding: 10px;
            font-size: 0.75rem;
            flex: 1;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .mimo-badge {
            background: var(--mimo);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            margin-left: 8px;
            font-weight: bold;
        }
        .result-window {
            margin-top: 20px;
            padding: 15px;
            background: #fdfdfd;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            color: #333;
            line-height: 1.4;
            min-height: 80px;
            word-break: break-word;
        }
        .tx-item {
            font-size: 0.75rem;
            color: #444;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            background: #fafafa;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .tx-item.pending {
            border-left: 4px solid var(--warning);
        }
        .tx-item.success {
            border-left: 4px solid var(--success);
            background: #f6fff6;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 8px;
            box-sizing: border-box;
            font-size: 0.8rem;
        }
        .did-container {
            font-size: 0.65rem;
            color: #666;
            background: #f0f2f5;
            padding: 6px;
            border-radius: 4px;
            margin-bottom: 8px;
            word-break: break-all;
            font-family: monospace;
            border: 1px solid #e1e4e8;
        }
    </style>
</head>
<body>

<div id="topNav">
    <div class="nav-title"><h1>Lightchain Identity Portal</h1><span style="font-size:0.6rem; color:#999;">v55.3</span></div>
    <div class="token-display"><span id="tokenBalance">0.0000</span> LCAI</div>
</div>

<div class="content-wrapper">
    <div id="leftSidebar">
        <div class="card" style="text-align: center;">
            <div id="userProfile" style="display:none; margin-bottom:15px;">
                <div id="userNameDisplay" style="font-size: 1.2rem; font-weight:800; color: #0056b3; margin-bottom: 5px;"></div>
                <div id="userDidDisplay" class="did-container"></div>
                <div style="font-size: 0.65rem; color: var(--success); font-weight: bold;">IDENTITY VERIFIED</div>
            </div>
            <div id="walletStatus" style="font-size: 0.7rem; color:#999; word-break: break-all; margin-bottom:10px;">Disconnected</div>
            <button id="connectBtn" class="primary-btn">Connect Wallet</button>
        </div>

        <div id="ownerConsole" class="card" style="display:none; border-top: 3px solid var(--owner);">
            <h4 style="color:var(--owner); margin: 0 0 10px 0; font-size: 0.9rem;">Oracle Owner</h4>
            <div style="font-size: 0.75rem; margin-bottom: 5px;"><strong>Role:</strong> Contract Admin</div>
            <div style="font-size: 0.75rem; margin-bottom: 5px;"><strong>AIVM Bridge:</strong> <span style="color:var(--success)">Connected</span></div>
            <div style="font-size: 0.75rem;"><strong>Global Queries:</strong> <span id="ownerQueryCount">0</span></div>
        </div>

        <div id="adminConsole" class="card" style="display:none; border-top: 3px solid var(--admin);">
            <h4 style="color:var(--admin); margin: 0 0 10px 0; font-size: 0.9rem;">Identity Admin</h4>
            <input type="text" id="lookupAddr" placeholder="Lookup 0x...">
            <button id="lookupBtn" class="primary-btn" style="padding: 8px; font-size: 0.75rem; background: var(--admin);">Query Status</button>
            <div id="lookupResults" style="display:none; padding:8px; font-size:0.7rem; background:#fff5f5; margin-top:10px; border-radius:6px; border: 1px solid #ffcaca;"></div>
            
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            
            <input type="text" id="verifyAddr" placeholder="Target 0x...">
            <div style="display:flex; gap: 5px;">
                <button id="verifyBtn" class="small-btn" style="background:var(--success);">Verify</button>
                <button id="revokeBtn" class="small-btn" style="background:var(--admin);">Revoke</button>
            </div>
            <div id="actionResults" style="display:none; padding:8px; font-size:0.7rem; background:#e8f5e9; border-radius:6px; margin-top:10px;"></div>
        </div>
    </div>

    <div class="main-utility-area">
        <div id="oracleUI" style="display:none; width: 100%; max-width: 550px;">
            <div class="card" style="text-align: center; border-top: 4px solid var(--success);">
                <h2 style="font-size: 1.3rem; margin-top: 0;">AIVM Oracle</h2>
                <input type="text" id="oracleQuestion" placeholder="Consult the cluster...">
                <button id="shakeBtn" class="primary-btn" style="background: var(--success);">Consult AIVM</button>
                <div class="result-window" id="resultText">Awaiting inference...</div>
            </div>
        </div>
    </div>

    <div id="rightSidebar">
        <div class="card">
            <h4 style="margin:0; color: #0056b3; font-size:0.85rem;">Activity Log</h4>
            <div style="font-size: 0.75rem; margin:8px 0;">Queries: <strong id="globalCount">0</strong></div>
            <div id="txFeed" style="max-height: 550px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<script>
    const IDENTITY_CONTRACT = "0xe0087e581f11b9de0d61697a0cb0cdffca8f1f34";
    // FIXED: Checksum error caused by mixed-casing. Forced to lowercase.
    const BALL_CONTRACT_ADDR = "0xf441869850125807188771a3065aa3d5d184d81b"; 

    const BALL_ABI = [{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"answer","type":"string"}],"name":"OracleAnswer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"question","type":"string"}],"name":"OracleRequest","type":"event"},{"inputs":[{"internalType":"string","name":"_userQuestion","type":"string"}],"name":"getPrediction","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalPredictions","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"latestAnswer","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}];
    const IDENTITY_ABI = [{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getIdentity","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"isAdmin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"verifyIdentity","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"revokeVerification","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    let signer, ballContract, identityContract, provider;

    async function hardSync() {
        try {
            const address = await signer.getAddress();
            const balance = await provider.getBalance(address);
            
            document.getElementById('tokenBalance').innerText = parseFloat(ethers.formatEther(balance)).toFixed(4);
            document.getElementById('walletStatus').innerText = "Connected: " + address.substring(0, 14) + "...";

            const [profile, ballAdmin, isIdAdmin, total, lastAns] = await Promise.all([
                identityContract.getIdentity(address).catch(() => ["User", "", false]),
                ballContract.admin().catch(() => ""),
                identityContract.isAdmin(address).catch(() => false),
                ballContract.totalPredictions().catch(() => 0),
                ballContract.latestAnswer(address).catch(() => "")
            ]);

            document.getElementById('globalCount').innerText = total.toString();
            document.getElementById('ownerQueryCount').innerText = total.toString();

            if (lastAns && lastAns !== "AI_CLUSTER_SYNC_PENDING" && lastAns !== "") {
                document.getElementById('resultText').innerText = lastAns;
            }

            if (ballAdmin.toLowerCase() === address.toLowerCase()) document.getElementById('ownerConsole').style.display = 'block';
            if (isIdAdmin) document.getElementById('adminConsole').style.display = 'block';
            
            if (profile[2]) {
                document.getElementById('oracleUI').style.display = 'block';
                document.getElementById('userProfile').style.display = 'block';
                document.getElementById('userNameDisplay').innerHTML = `${profile[0]} <span class="mimo-badge">âœ“</span>`;
                // FIXED: Inject the DID layout
                document.getElementById('userDidDisplay').innerText = profile[1];
            }

            await scanHistory();
        } catch (e) {
            console.error("Sync Failure:", e);
        }
    }

    async function connectWallet() {
        try {
            if (!window.ethereum) return alert("MetaMask not found!");
            
            provider = new ethers.BrowserProvider(window.ethereum);
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            signer = await provider.getSigner();
            
            ballContract = new ethers.Contract(BALL_CONTRACT_ADDR, BALL_ABI, signer);
            identityContract = new ethers.Contract(IDENTITY_CONTRACT, IDENTITY_ABI, signer);
            
            document.getElementById('connectBtn').style.display = 'none';
            await hardSync();

            ballContract.on("OracleAnswer", (user, answer) => {
                if (user.toLowerCase() === signer.address.toLowerCase()) {
                    document.getElementById('resultText').innerText = answer;
                    document.getElementById('shakeBtn').disabled = false;
                    hardSync();
                }
            });
        } catch (e) {
            console.error("Connection Error:", e);
        }
    }

    async function scanHistory() {
        try {
            const [reqs, ans] = await Promise.all([
                ballContract.queryFilter(ballContract.filters.OracleRequest(), -2000).catch(() => []),
                ballContract.queryFilter(ballContract.filters.OracleAnswer(), -2000).catch(() => [])
            ]);

            const feed = document.getElementById('txFeed');
            const combined = [...reqs.map(e => ({type:'req', text:e.args[1]})), ...ans.map(e => ({type:'ans', text:e.args[1]}))];
            
            if (combined.length === 0) {
                feed.innerHTML = '<div style="text-align:center; color:#999; font-size:0.7rem; padding:20px;">No activity found in recent blocks.</div>';
            } else {
                feed.innerHTML = combined.reverse().map(item => `
                    <div class="tx-item ${item.type === 'ans' ? 'success' : 'pending'}">
                        <strong>${item.type === 'ans' ? 'Vision' : 'Question'}:</strong><br>${item.text}
                    </div>
                `).join('');
            }
        } catch (e) {
            console.error("History Scan Error:", e);
        }
    }

    window.onload = () => {
        document.getElementById('connectBtn').onclick = connectWallet;

        document.getElementById('shakeBtn').onclick = async () => {
            const q = document.getElementById('oracleQuestion').value;
            if (!q) return;
            
            const btn = document.getElementById('shakeBtn');
            const resText = document.getElementById('resultText');
            
            btn.disabled = true;
            resText.innerHTML = "Broadcasting to PoI Cluster...<br><br><span style='color:var(--warning); font-size:0.85rem;'>Please check MetaMask to confirm the transaction.</span>";
            
            try {
                const tx = await ballContract.getPrediction(q, { gasLimit: 3000000 });
                resText.innerHTML = "Transaction Submitted!<br><br><span style='font-size:0.85rem;'>Waiting for blockchain confirmation...</span>";
                await tx.wait();
                
                resText.innerHTML = "Anchored. Awaiting consensus from AIVM...";
                await hardSync();
            } catch (e) {
                btn.disabled = false;
                let errorMsg = e.reason || e.message || "Transaction rejected.";
                if(errorMsg.includes("user rejected")) errorMsg = "You rejected the transaction in MetaMask.";
                resText.innerHTML = `<span style="color:var(--admin); font-weight:bold;">Error:</span> ${errorMsg}`;
                console.error("Consult Error:", e);
            }
        };

        document.getElementById('lookupBtn').onclick = async () => {
            const addr = document.getElementById('lookupAddr').value;
            const res = document.getElementById('lookupResults');
            res.style.display = 'block';
            res.innerText = "Querying...";
            try {
                const data = await identityContract.getIdentity(addr);
                res.innerHTML = `<strong>Name:</strong> ${data[0]}<br><strong>Verified:</strong> ${data[2]}`;
            } catch(e) {
                res.innerText = "Error: Not Found.";
            }
        };

        document.getElementById('verifyBtn').onclick = async () => {
            const addr = document.getElementById('verifyAddr').value;
            const out = document.getElementById('actionResults');
            out.style.display = 'block';
            out.innerText = "Verifying...";
            try {
                await (await identityContract.verifyIdentity(addr)).wait();
                out.innerText = "Success!";
                await hardSync();
            } catch(e) {
                out.innerText = "Failed.";
            }
        };

        document.getElementById('revokeBtn').onclick = async () => {
            const addr = document.getElementById('verifyAddr').value;
            const out = document.getElementById('actionResults');
            out.style.display = 'block';
            out.innerText = "Revoking...";
            try {
                await (await identityContract.revokeVerification(addr)).wait();
                out.innerText = "Success!";
                await hardSync();
            } catch(e) {
                out.innerText = "Failed.";
            }
        };
    };
</script>
</body>
</html>
