<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightchain AI | Privacy Identity Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #00ffa3; --bg: #0a0a0b; --card: #141417; --text: #e0e0e0; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
        h2 { margin: 0; font-size: 24px; }
        .highlight { color: var(--primary); }
        .card { background: var(--card); border: 1px solid #2d2d33; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn { background: var(--primary); color: #000; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn:disabled { background: #333; color: #777; cursor: not-allowed; }
        
        /* Gating Logic Classes */
        .gated { display: none; }
        .visible { display: block; }

        /* Navigation Tabs */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #2d2d33; padding-bottom: 10px; }
        .tab { cursor: pointer; padding: 8px 16px; border-radius: 4px; transition: background 0.2s; }
        .tab:hover { background: #222; }
        .tab.active { background: var(--primary); color: #000; font-weight: bold; }
        
        #status { font-size: 0.9em; margin-top: 15px; text-align: center; color: #888; }
        .badge { background: rgba(0, 255, 163, 0.1); color: var(--primary); padding: 5px 10px; border-radius: 20px; font-size: 0.8em; border: 1px solid var(--primary); }
    </style>
</head>
<body>
    <div class="container">
<header>
    <h2>Lightchain AI <span class="highlight">Identity</span></h2>
    <div style="display: flex; align-items: center; gap: 10px;">
        <span id="sbtStatusBadge" class="badge" style="display:none;"></span>
        <button id="connectBtn" class="btn" style="width: auto;">Connect Wallet</button>
    </div>
</header>

        <div id="gateArea" class="card visible" style="text-align: center; margin-top: 40px;">
            <h3 style="font-size: 20px; margin-bottom: 15px;">Privacy-Preserving KYC</h3>
            <p style="color: #aaa; margin-bottom: 25px; line-height: 1.5;">
                Your wallet is currently unverified. To access the AIVM Oracle and advanced network features, you must generate a Zero-Knowledge Proof of your identity using zkPass.
            </p>
            <button id="verifyBtn" class="btn" disabled style="width: 100%; max-width: 300px;">Verify via zkPass & Mint SBT</button>
            <p id="status">Please connect your wallet to check verification status.</p>
        </div>

        <div id="dashboardArea" class="gated">
            <div class="nav-tabs">
                <div class="tab active" onclick="switchTab('oracle')">AIVM Oracle</div>
                <div class="tab" onclick="switchTab('identity')">Identity Registry</div>
            </div>

            <div id="oracleView" class="card visible">
                <h3>Oracle Inference</h3>
                <p style="color: #aaa; font-size: 0.9em;">Ask the decentralized AIVM cluster. Protected by ZK-KYC.</p>
                <input type="text" id="oracleInput" placeholder="Enter prompt..." style="width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: white; border-radius: 6px;">
                <button class="btn" onclick="alert('Oracle interaction initiated!')">Request Inference</button>
                <div id="oracleOutput" style="margin-top:20px; font-family: monospace; color: var(--primary); background: #000; padding: 15px; border-radius: 6px; border: 1px solid #333;">Awaiting command...</div>
            </div>

            <div id="identityView" class="card gated">
                <h3>Identity Management</h3>
                <p style="color: #aaa; font-size: 0.9em;">Your on-chain attestations and registry status.</p>
                <div style="background: #000; padding: 15px; border-radius: 6px; border: 1px solid #333;">
                    <p>Registry Status: <span class="highlight" style="font-weight: bold;">VERIFIED (ZK-SBT FOUND)</span></p>
                    <p style="margin-bottom: 0;">SBT Contract: <span style="font-family: monospace; color: #aaa;" id="displaySbtAddr">Loading...</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>

        const SBT_ADDR = "0xa344e0f391e8DCfd6195D89b910C5Beb27525c4F"; 
        
        let signer;
        let provider;

async function init() {
    if (typeof window.ethereum !== 'undefined') {
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            
            const address = await signer.getAddress();
            // Update Wallet Button Text
            document.getElementById('connectBtn').innerText = address.substring(0,6) + "..." + address.slice(-4);
            
            await checkVerification();
        } catch (error) {
            console.error("Connection failed:", error);
        }
    }
}

async function checkVerification() {
    try {
        const sbtContract = new ethers.Contract(SBT_ADDR, ["function hasSBT(address) view returns (bool)"], signer);
        const userAddr = await signer.getAddress();
        const isVerified = await sbtContract.hasSBT(userAddr);

        const badge = document.getElementById('sbtStatusBadge');
        badge.style.display = "inline-block";

        if (isVerified) {
            // Update Badge to Verified
            badge.innerText = "✓ ZK-SBT";
            badge.style.borderColor = "var(--primary)";
            badge.style.color = "var(--primary)";
            
            // Unlock the dashboard
            document.getElementById('gateArea').classList.replace('visible', 'gated');
            document.getElementById('dashboardArea').classList.replace('gated', 'visible');
        } else {
            // Update Badge to Unverified
            badge.innerText = "✕ Unverified";
            badge.style.borderColor = "#ff4444";
            badge.style.color = "#ff4444";
            
            document.getElementById('verifyBtn').disabled = false;
        }
    } catch (error) {
        console.error("Verification check failed:", error);
    }
}

        function switchTab(tab) {
            document.getElementById('oracleView').className = tab === 'oracle' ? 'card visible' : 'card gated';
            document.getElementById('identityView').className = tab === 'identity' ? 'card visible' : 'card gated';
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        document.getElementById('connectBtn').addEventListener('click', init);
        
        // Placeholder for future SnarkJS/zkPass integration
document.getElementById('verifyBtn').addEventListener('click', async () => {
    try {
        document.getElementById('status').innerText = "Initiating Minting Transaction...";
        
        // Define the SBT Contract Instance
        const sbtContract = new ethers.Contract(
            SBT_ADDR, 
            ["function verifyAndMint(uint[2] _pA, uint[2][2] _pB, uint[2] _pC, uint[1] _pubSignals) external"], 
            signer
        );

        /** * DUMMY PROOF DATA 
         * These are placeholder values. In production, these are generated 
         * locally by SnarkJS or provided by the zkPass SDK.
         */
        const pA = ["0", "0"];
        const pB = [["0", "0"], ["0", "0"]];
        const pC = ["0", "0"];
        const pubSignals = [Math.floor(Math.random() * 1000000).toString()]; // Unique Nullifier

        // 1. Send the Transaction
        const tx = await sbtContract.verifyAndMint(pA, pB, pC, pubSignals);
        document.getElementById('status').innerText = "Transaction Sent! Waiting for confirmation...";
        
        // 2. Wait for block confirmation
        await tx.wait();
        
        document.getElementById('status').innerText = "SBT Minted Successfully!";
        document.getElementById('status').style.color = "var(--primary)";

        // 3. Refresh the UI to reveal the Dashboard
        await checkVerification();

    } catch (error) {
        console.error("Minting failed:", error);
        document.getElementById('status').innerText = "Minting failed. Check console for details.";
        document.getElementById('status').style.color = "#ff4444";
    }
});
    </script>
</body>
</html>



