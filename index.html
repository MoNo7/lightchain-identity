<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | Final Fix Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #00d1ff; --bg: #050505; --sidebar: #0d0d0e; --card: #141417; --text: #e0e0e0; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        aside { width: 260px; background: var(--sidebar); border-right: 1px solid #222; padding: 20px; display: flex; flex-direction: column; }
        .nav-item { padding: 12px; cursor: pointer; color: #888; border-radius: 8px; margin-bottom: 5px; }
        .nav-item.active { background: rgba(0, 209, 255, 0.1); color: var(--primary); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: #ff4444; margin-right: 5px; }
        .online { background: #00ff88; box-shadow: 0 0 8px #00ff88; }
        main { flex: 1; padding: 40px; overflow-y: auto; }
        .card { background: var(--card); border: 1px solid #222; padding: 25px; border-radius: 12px; }
        .btn { background: var(--primary); color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #artLog { margin-top: 20px; background: #000; padding: 10px; border-radius: 8px; max-height: 300px; overflow-y: auto; }
        .log-entry { font-size: 11px; padding: 8px; border-bottom: 1px solid #222; cursor: pointer; }
    </style>
</head>
<body>
    <aside>
        <div style="font-weight:bold; margin-bottom:20px;">LCAI Identity</div>
        <div class="nav-item active">AI Art Generator</div>
        <div style="margin-top:auto; font-size:11px;">
            <div id="gpuHealth"><span class="status-dot" id="dot"></span> Cluster: Offline</div>
            <div id="gpuLoad" style="color:#555">Load: Checking...</div>
        </div>
    </aside>

    <main>
        <header style="display:flex; justify-content:flex-end; margin-bottom:20px;">
            <button id="connectBtn" class="btn" onclick="connect()">Connect Wallet</button>
        </header>

        <div class="card" id="artUI" style="display:none">
            <input type="text" id="artPrompt" placeholder="Panda on Mars..." style="width:80%; padding:10px; background:#000; border:1px solid #333; color:#fff;">
            <button id="genBtn" class="btn">Generate Art</button>
            <p id="status" style="color:#888; font-size:12px;">Ready.</p>
            <div id="artLog"></div>
            <div id="viewer" style="margin-top:20px; text-align:center;"></div>
        </div>
    </main>

    <script>
        const ROUTER = "0x0269683E61b210d56b3D692603336fEB27B8a83a";
        const API = "https://chat2.lightchain.ai/api/v1";
        let provider, signer, userTasks = JSON.parse(localStorage.getItem('lcai_tasks') || '[]');

        async function connect() {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            const addr = await signer.getAddress();
            document.getElementById('connectBtn').innerText = addr.substring(0,6)+"...";
            document.getElementById('artUI').style.display = 'block';
            updateHealth();
            renderLog();
            userTasks.forEach((t, i) => { if(!t.ready) pollTask(i); });
        }

        async function updateHealth() {
            try {
                const res = await fetch(`${API}/chat/health`);
                const data = await res.json();
                document.getElementById('dot').classList.add('online');
                document.getElementById('gpuHealth').innerText = "Cluster: Online";
                document.getElementById('gpuLoad').innerText = `Global Load: ${data.load || 'Normal'}%`;
            } catch(e) {}
        }

        document.getElementById('genBtn').onclick = async () => {
            const prompt = document.getElementById('artPrompt').value;
            const status = document.getElementById('status');
            status.innerText = "Signing Transaction...";
            try {
                const router = new ethers.Contract(ROUTER, ["function requestInferenceV2(uint256 m, string p) external payable"], signer);
                const tx = await router.requestInferenceV2(2, prompt, { value: ethers.parseEther("0.1") });
                
                // PUSH TO LOG IMMEDIATELY
                const idx = userTasks.push({ prompt, taskId: "Searching...", ready: false, tx: tx.hash }) - 1;
                renderLog();
                
                const receipt = await tx.wait();
                // SEARCH ALL LOGS FOR ANY 32-BYTE TOPIC
                const log = receipt.logs.find(l => l.address.toLowerCase() === ROUTER.toLowerCase() && l.topics.length > 1);
                
                if(log) {
                    userTasks[idx].taskId = log.topics[1];
                    localStorage.setItem('lcai_tasks', JSON.stringify(userTasks));
                    renderLog();
                    pollTask(idx);
                } else {
                    status.innerText = "Log Error. Try Recovery page.";
                }
            } catch (e) { status.innerText = "Failed."; console.error(e); }
        };

        async function pollTask(i) {
            const t = userTasks[i];
            if(t.taskId === "Searching...") return;
            try {
                const res = await fetch(`${API}/chat/status?taskId=${t.taskId}`);
                const data = await res.json();
                if(data.ready && data.url) {
                    t.ready = true; t.url = data.url;
                    localStorage.setItem('lcai_tasks', JSON.stringify(userTasks));
                    renderLog();
                } else setTimeout(() => pollTask(i), 5000);
            } catch(e) { setTimeout(() => pollTask(i), 10000); }
        }

        function renderLog() {
            const log = document.getElementById('artLog');
            log.innerHTML = userTasks.map((t, i) => `
                <div class="log-entry" onclick="viewArt(${i})">
                    <b>#${i+1}</b> ${t.prompt.slice(0,10)}... [${t.ready ? 'READY' : 'QUEUED'}]
                </div>
            `).join('');
        }

        function viewArt(i) {
            const t = userTasks[i];
            const viewer = document.getElementById('viewer');
            if(t.ready) {
                viewer.innerHTML = `<img src="${t.url}" style="width:100%; border-radius:10px;"><br><a href="${t.url}" download class="btn">Download</a>`;
            } else viewer.innerHTML = `<p>ID: ${t.taskId.slice(0,10)}... is still processing.</p>`;
        }

        // Listen for the AI Router Callback
artContract.on("ArtCompleted", async (user, imageUrl, taskId) => {
    const myAddr = await signer.getAddress();
    
    // Only update if the callback belongs to the connected wallet
    if (user.toLowerCase() === myAddr.toLowerCase()) {
        console.log("AIVM Callback Received! TaskID:", taskId);
        
        const displayBox = document.getElementById('artResultWindow');
        displayBox.innerHTML = `
            <div style="color: var(--success); font-weight: bold; margin-bottom: 10px;">Inference Complete!</div>
            <img src="${imageUrl}" alt="AI Generated Art" style="max-width: 100%; border-radius: 8px; border: 2px solid #e1e4e8;">
        `;
        
        logToSidebar(`Task ${taskId.substring(0,8)}... Completed.`);
    }
});
        
    </script>
</body>
</html>

