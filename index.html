<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | IAM Control Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --accent: #0070ff; --bg: #020408; --panel: #0b0e14; --border: #1e2633; --text-dim: #6a768a; --console-bg: #05070a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        nav { width: 280px; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 25px; background: var(--panel); box-sizing: border-box; }
        .nav-logo { font-weight: 900; letter-spacing: 2px; color: var(--accent); margin-bottom: 25px; font-size: 1.1rem; text-align: center; }
        .system-console { background: var(--console-bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; height: 180px; overflow-y: auto; margin-bottom: 20px; color: #4e5d75; line-height: 1.5; }
        .console-line { margin-bottom: 4px; border-left: 2px solid #1a202c; padding-left: 8px; }
        .console-line.success { border-left-color: var(--accent); color: #fff; }
        .console-line.error { border-left-color: #ff4444; color: #ff4444; }
        .nav-menu { display: none; flex-direction: column; gap: 5px; }
        .nav-link { color: var(--text-dim); padding: 12px 15px; cursor: pointer; border-radius: 6px; border: none; background: none; text-align: left; font-size: 0.75rem; font-family: monospace; font-weight: 600; }
        .nav-link:hover, .nav-link.active { color: white; background: var(--accent); }
        .viewport { flex: 1; display: flex; flex-direction: column; }
        header { height: 80px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; position: relative; }
        .tickers { display: flex; gap: 25px; font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; position: absolute; left: 50%; transform: translateX(-50%); }
        .header-right { display: flex; align-items: center; gap: 10px; margin-left: auto; }
        .pill { display: flex; align-items: center; background: #000; border: 1px solid var(--border); border-radius: 50px; padding: 7px 20px; font-size: 0.7rem; color: var(--accent); font-family: monospace; }
        .wallet-pill { background: var(--accent); color: white; border-radius: 50px; padding: 9px 20px; font-weight: 900; cursor: pointer; border: none; font-size: 0.75rem; }
        .view-pane { flex: 1; padding: 45px; display: none; overflow-y: auto; }
        .view-pane.active { display: block !important; }
        .card { background: var(--panel); border: 1px solid var(--border); padding: 35px; border-radius: 12px; max-width: 750px; border-top: 4px solid var(--accent); margin-bottom: 20px; }
        .panel-input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 4px; font-size: 0.75rem; margin-bottom: 12px; box-sizing: border-box; }
        .action-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 8px; }
        pre { background: var(--console-bg); padding: 20px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.75rem; color: #a0aec0; margin: 20px 0; white-space: pre-wrap; word-break: break-all; }
        #qr-target { background: white; padding: 12px; display: inline-block; border-radius: 8px; }
    </style>
</head>
<body>

<nav>
    <div class="nav-logo">LCAI <span>IAM</span></div>
    <div class="system-console" id="console">
        <div class="console-line">>> SYSTEM REBOOT... SUCCESS</div>
    </div>
    <div class="nav-menu" id="side-menu">
        <button class="nav-link active" onclick="showView('id-view', this)">ZK IDENTITY</button>
        <button class="nav-link" onclick="showView('recovery-view', this)">ADMIN TOOLS</button>
        <button class="nav-link" onclick="showView('aivm-view', this)">AIVM INFERENCE</button>
        <button class="nav-link" onclick="showView('gallery-view', this); initGallery();">GALLERY</button>
    </div>
</nav>

<div class="viewport">
    <header>
        <div class="tickers">
            <div class="ticker-item">ETH: <span id="eth-price">$---</span></div>
            <div class="ticker-item">LCAI: <span id="lcai-price">$---</span></div>
        </div>
        <div class="header-right">
            <div class="pill">AIVM-THETA | <span id="load-num">0%</span> | <span id="status-txt">IDLE</span></div>
            <button id="wallet-btn" class="wallet-pill" onclick="connectWallet()">CONNECT</button>
        </div>
    </header>

    <div id="id-view" class="view-pane active">
        <div class="card">
            <h2>ZK-SBT IDENTITY</h2>
            <pre id="id-json">{ "status": "offline" }</pre>
            <div id="qr-target"></div>
        </div>
    </div>

    <div id="recovery-view" class="view-pane">
        <div class="card">
            <h2>ADMIN RECOVERY</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <input type="text" class="panel-input" placeholder="Address" id="admin-addr">
                    <button class="action-btn" onclick="runAdmin('queryStatus')">QUERY STATUS</button>
                    <button class="action-btn" onclick="runAdmin('setVerification', true)">VERIFY USER</button>
                </div>
                <div style="background:#000; padding:20px; border-radius:8px; border:1px solid var(--border); text-align:center;">
                    <small>VAULT (tLCAI)</small>
                    <div style="font-size:1.4rem; font-weight:bold; margin:10px 0;" id="revenue-val">0.00</div>
                    <button class="action-btn" onclick="runOwner()">WITHDRAW</button>
                </div>
            </div>
        </div>
    </div>

    <div id="aivm-view" class="view-pane">
        <div class="card">
            <h2>AIVM INFERENCE</h2>
            <textarea id="art-prompt" class="panel-input" placeholder="Prompt..." style="height: 100px;"></textarea>
            <button class="action-btn" onclick="generateArt()">REQUEST INFERENCE (0.001 tLCAI)</button>
        </div>
    </div>

    <div id="gallery-view" class="view-pane">
        <div class="card"><h2>GALLERY</h2><div id="gallery-grid"></div></div>
    </div>
</div>

<script>
const CONFIG = {
    addr: "0xbcA38515887Dc3Ca163398C0Ef7bF02dd156D8FB",
    abi: [
        "function owner() public view returns (address)",
        "function setVerification(address user, bool status) external",
        "function withdraw() external",
        "function manualVerified(address) public view returns (bool)",
        "function requestInference(string prompt) external payable",
        "event InferenceRequested(address indexed user, string prompt)"
    ]
};

let user, provider, signer, contract;

const log = (msg, type = "") => {
    const l = document.createElement('div');
    l.className = `console-line ${type}`;
    l.innerText = `>> ${msg}`;
    const cb = document.getElementById('console');
    cb.appendChild(l);
    cb.scrollTop = cb.scrollHeight;
};

async function connectWallet() {
    if(!window.ethereum) return log("NO WALLET", "error");
    try {
        provider = new ethers.BrowserProvider(window.ethereum);
        const accs = await provider.send("eth_requestAccounts", []);
        user = accs[0]; signer = await provider.getSigner();
        contract = new ethers.Contract(CONFIG.addr, CONFIG.abi, signer);
        
        const owner = await contract.owner();
        const isOwner = user.toLowerCase() === owner.toLowerCase();
        
        document.getElementById('wallet-btn').innerText = user.slice(0,6).toUpperCase();
        document.getElementById('side-menu').style.display = 'flex';
        log("CONNECTION SUCCESS", "success");
        
        const identityData = {
            "identity": { "role": isOwner ? "SYSTEM_OWNER" : "OPERATOR", "address": user },
            "nexus": { "contract": CONFIG.addr, "network": "Lightchain_Testnet" }
        };
        document.getElementById('id-json').innerText = JSON.stringify(identityData, null, 4);
        document.getElementById('qr-target').innerHTML = "";
        new QRCode(document.getElementById("qr-target"), { text: user, width: 120, height: 120 });
        refreshBalance();
    } catch(e) { log("CONN FAIL", "error"); }
}

async function runAdmin(method, status = null) {
    if(!contract) return;
    const target = document.getElementById('admin-addr').value || user;
    try {
        if(method === 'queryStatus') {
            const res = await contract.manualVerified(target);
            log(`${target.slice(0,6)} Verified: ${res}`, "success");
        } else {
            const tx = await contract.setVerification(target, status);
            await tx.wait(); log("UPDATED", "success");
        }
    } catch(e) { log("PERMISSION DENIED", "error"); }
}

async function refreshBalance() {
    if(!provider) return;
    const bal = await provider.getBalance(CONFIG.addr);
    document.getElementById('revenue-val').innerText = ethers.formatEther(bal).slice(0,6);
}

async function syncTickers() {
    try {
        const r = await fetch('https://min-api.cryptocompare.com/data/price?fsym=ETH&tsyms=USD');
        const d = await r.json(); 
        document.getElementById('eth-price').innerText = `$${d.USD}`;
        // LCAI Fallback/Mock for Testnet
        document.getElementById('lcai-price').innerText = "$0.0021"; 
    } catch(e) {}
}
syncTickers();

function showView(id, btn) {
    document.querySelectorAll('.view-pane').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    btn.classList.add('active');
}
</script>
</body>
</html>
