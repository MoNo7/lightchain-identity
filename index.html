<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI Identity Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #007bff; --admin-blue: #0056b3; --bg: #f0f2f5; --text: #1c1e21; --success: #28a745; --mimo: #1877F2; --owner: #6f42c1; --warning: #f0ad4e; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #topNav { height: 60px; background: #fff; border-bottom: 1px solid #e1e4e8; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
        .nav-title h1 { font-size: 1.1rem; color: #0056b3; margin: 0; }
        .token-display { background: #f8f9fa; padding: 8px 15px; border-radius: 20px; border: 1px solid #e1e4e8; font-weight: 700; font-size: 0.85rem; color: var(--success); }
        .content-wrapper { display: flex; flex: 1; overflow: hidden; width: 100%; }
        #leftSidebar, #rightSidebar { width: 320px; min-width: 320px; max-width: 320px; background: #fff; padding: 20px; overflow-y: auto; border-right: 1px solid #e1e4e8; flex-shrink: 0; box-sizing: border-box; }
        #rightSidebar { border-right: none; border-left: 1px solid #e1e4e8; }
        .main-utility-area { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px; border: 1px solid #e1e4e8; width: 100%; box-sizing: border-box; }
        .primary-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; margin-top: 10px; transition: 0.2s; }
        .small-btn { padding: 10px; font-size: 0.75rem; flex: 1; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .result-window { margin-top: 20px; padding: 15px; background: #fdfdfd; border: 2px dashed #cbd5e0; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.95rem; color: #333; line-height: 1.4; min-height: 80px; word-break: break-word; }
        .tx-item { font-size: 0.75rem; color: #444; padding: 10px; border-bottom: 1px solid #f0f0f0; background: #fafafa; border-radius: 6px; margin-bottom: 8px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; box-sizing: border-box; font-size: 0.8rem; }
        .pulsing-text { animation: pulse 1.5s infinite; color: var(--warning); font-weight: bold; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="topNav">
    <div class="nav-title"><h1>Lightchain Identity Portal (Testnet)</h1><span style="font-size:0.6rem; color:#999;">v56.3 (Ready)</span></div>
    <div class="token-display"><span id="tokenBalance">0.0000</span> LCAI</div>
</div>

<div class="content-wrapper">
    <div id="leftSidebar">
        <div class="card" style="text-align: center;">
            <div id="userProfile" style="display:none; margin-bottom:15px;">
                <div id="userNameDisplay" style="font-size: 1.2rem; font-weight:800; color: #0056b3; margin-bottom: 5px;"></div>
                <div style="font-size: 0.65rem; color: var(--success); font-weight: bold;">IDENTITY VERIFIED</div>
            </div>
            <button id="connectBtn" class="primary-btn">Connect Wallet</button>
        </div>

        <div id="adminConsole" class="card" style="display:none; border-top: 4px solid var(--admin-blue); background: #f8fbff;">
            <h4 style="color:var(--admin-blue); margin: 0 0 10px 0; font-size: 0.9rem;">Identity Admin</h4>
            <input type="text" id="lookupAddr" placeholder="Lookup 0x...">
            <button id="lookupBtn" class="primary-btn" style="padding: 8px; font-size: 0.75rem; background: var(--admin-blue);">Query Status</button>
            <div id="lookupResults" style="display:none; padding:12px; font-size:0.75rem; background:#fff; margin-top:10px; border-radius:8px; border: 1px solid #b8daff; line-height:1.6;"></div>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <input type="text" id="verifyAddr" placeholder="Target 0x...">
            <div style="display:flex; gap: 5px;">
                <button id="verifyBtn" class="small-btn" style="background:var(--success);">Verify</button>
                <button id="revokeBtn" class="small-btn" style="background:var(--danger);">Revoke</button>
            </div>
            <div id="actionResults" style="display:none; padding:10px; font-size:0.75rem; background:#e8f5e9; border-radius:8px; margin-top:10px; border: 1px solid var(--success); text-align:center;"></div>
        </div>

        <div id="ownerConsole" class="card" style="display:none; border-top: 3px solid var(--owner);">
            <h4 style="color:var(--owner); margin: 0 0 10px 0; font-size: 0.9rem;">Oracle Owner</h4>
            <div style="font-size: 0.75rem; margin-bottom: 5px;"><strong>Vault Balance:</strong> <span id="vaultBalance" style="color:var(--success); font-weight:bold;">0.0000</span> LCAI</div>
            <div style="font-size: 0.7rem; margin-bottom: 10px; color:#666;">Next Release: <span id="releaseCountdown">Calculating...</span></div>
            <div style="display:flex; gap: 5px; margin-top:10px;">
                <button id="feeOnBtn" class="small-btn" style="background:var(--success);">Toggle: ON</button>
                <button id="feeOffBtn" class="small-btn" style="background:var(--danger);">Toggle: OFF</button>
            </div>
        </div>
    </div>

    <div class="main-utility-area">
        <div id="oracleUI" style="display:none; width: 100%; max-width: 550px;">
            <div class="card" style="text-align: center; border-top: 4px solid var(--success);">
                <h2 style="font-size: 1.3rem; margin-top: 0;">AIVM Oracle</h2>
                <input type="text" id="oracleQuestion" placeholder="Consult the cluster...">
                <button id="shakeBtn" class="primary-btn" style="background: var(--success);">Consult AIVM</button>
                <div class="result-window" id="resultText">Awaiting inference...</div>
            </div>
        </div>
    </div>

    <div id="rightSidebar">
        <div class="card">
            <h4 style="margin:0; color: #0056b3; font-size:0.85rem;">Activity Log</h4>
            <div id="txFeed" style="max-height: 550px; overflow-y: auto; margin-top:10px;"></div>
        </div>
    </div>
</div>

<script>
    const IDENTITY_CONTRACT = "0xe0087e581f11b9de0d61697a0cb0cdffca8f1f34";

    const BALL_CONTRACT_ADDR = "0xE711a45A29D559600EEEb4F1dcC5F03067737758"; 

    const BALL_ABI = ["function getPrediction(string) payable", "function fulfillOracle(address, string)", "function admin() view returns (address)", "function feesEnabled() view returns (bool)", "function lastPayoutTime() view returns (uint256)", "function toggleFees(bool)", "function latestAnswer(address) view returns (string)", "event OracleRequest(address indexed, string, bytes32)", "event OracleAnswer(address indexed, string)"];
    const IDENTITY_ABI = ["function getIdentity(address) view returns (string, string, bool)", "function isAdmin(address) view returns (bool)", "function verifyIdentity(address)", "function revokeVerification(address)"];

    let signer, ballContract, identityContract, provider;

    async function hardSync() {
        try {
            const address = await signer.getAddress();
            const balance = await provider.getBalance(address);
            const vaultBal = await provider.getBalance(BALL_CONTRACT_ADDR);
            document.getElementById('tokenBalance').innerText = parseFloat(ethers.formatEther(balance)).toFixed(4);
            document.getElementById('vaultBalance').innerText = parseFloat(ethers.formatEther(vaultBal)).toFixed(4);

            const res = await Promise.all([
                identityContract.getIdentity(address).catch(() => ["User", "", false]),
                ballContract.admin().catch(() => ""),
                identityContract.isAdmin(address).catch(() => false),
                ballContract.feesEnabled().catch(() => false),
                ballContract.lastPayoutTime().catch(() => 0),
                ballContract.latestAnswer(address).catch(() => "")
            ]);

            const [profile, ballAdmin, isIdAdmin, isFeeOn, lastPayout, lastAns] = res;

            if (lastAns && lastAns !== "") {
                if (lastAns === "AI_CLUSTER_SYNC_PENDING") {
                    document.getElementById('resultText').innerHTML = '<span class="pulsing-text">AI Cluster Processing...</span>';
                } else {
                    document.getElementById('resultText').innerText = lastAns;
                }
            }
            
            const diff = (Number(lastPayout) + 86400) - Math.floor(Date.now() / 1000);
            document.getElementById('releaseCountdown').innerText = (diff <= 0) ? "Ready" : `${Math.floor(diff/3600)}h remaining`;

            if (ballAdmin.toLowerCase() === address.toLowerCase()) document.getElementById('ownerConsole').style.display = 'block';
            if (isIdAdmin) document.getElementById('adminConsole').style.display = 'block';
            if (profile[2]) {
                document.getElementById('oracleUI').style.display = 'block';
                document.getElementById('userProfile').style.display = 'block';
                document.getElementById('userNameDisplay').innerHTML = `${profile[0]} <span style="color:var(--mimo)">✓</span>`;
            }
            await scanHistory();
        } catch (e) { console.error("Sync Error:", e); }
    }

    async function connectWallet() {
        if (!window.ethereum) return alert("MetaMask not found!");
        provider = new ethers.BrowserProvider(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        signer = await provider.getSigner();
        ballContract = new ethers.Contract(BALL_CONTRACT_ADDR, BALL_ABI, signer);
        identityContract = new ethers.Contract(IDENTITY_CONTRACT, IDENTITY_ABI, signer);
        
        ballContract.on("OracleAnswer", (user, answer) => {
            signer.getAddress().then(addr => {
                if(user.toLowerCase() === addr.toLowerCase() && answer !== "AI_CLUSTER_SYNC_PENDING") {
                    document.getElementById('resultText').innerText = answer;
                    hardSync();
                }
            });
        });

        document.getElementById('connectBtn').style.display = 'none';
        await hardSync();
    }

    async function scanHistory() {
        const [reqs, ans] = await Promise.all([
            ballContract.queryFilter(ballContract.filters.OracleRequest(), -2000).catch(() => []),
            ballContract.queryFilter(ballContract.filters.OracleAnswer(), -2000).catch(() => [])
        ]);
        const combined = [...reqs.map(e => ({type:'req', text:e.args[1]})), ...ans.map(e => ({type:'ans', text:e.args[1]}))];
        document.getElementById('txFeed').innerHTML = combined.reverse().map(item => {
            if (item.text === "AI_CLUSTER_SYNC_PENDING") return "";
            return `<div class="tx-item" style="border-left: 4px solid ${item.type === 'ans' ? 'var(--success)' : 'var(--warning)'}; background: ${item.type === 'ans' ? '#f6fff6' : '#fff9f0'};">
                <strong>${item.type === 'ans' ? 'Answer' : 'Question'}:</strong><br>${item.text}
            </div>`;
        }).join('');
    }

    window.onload = () => {
        document.getElementById('connectBtn').onclick = connectWallet;
        document.getElementById('lookupBtn').onclick = async () => {
            const addr = document.getElementById('lookupAddr').value;
            const resBox = document.getElementById('lookupResults');
            resBox.style.display = 'block';
            try {
                const data = await identityContract.getIdentity(addr);
                resBox.innerHTML = `<strong>User:</strong> ${data[0]} <br><strong>DID:</strong> ${data[1]} <br><strong>Status:</strong> ${data[2] ? '✅' : '❌'} `;
            } catch(e) { resBox.innerText = "Error."; }
        };
        document.getElementById('verifyBtn').onclick = async () => {
            const out = document.getElementById('actionResults');
            out.style.display = 'block'; out.innerText = "Pending...";
            try { await (await identityContract.verifyIdentity(document.getElementById('verifyAddr').value)).wait(); out.innerText = "Success!"; await hardSync(); } catch(e) { out.innerText = "Failed."; }
        };
        document.getElementById('shakeBtn').onclick = async () => {
            document.getElementById('resultText').innerHTML = '<span class="pulsing-text">Broadcasting to AI Router...</span>';
            try { 
                // Using 0.1 LCAI fee for Testnet workers
                await (await ballContract.getPrediction(document.getElementById('oracleQuestion').value, { value: ethers.parseEther("0.1"), gasLimit: 6000000 })).wait();
                document.getElementById('resultText').innerHTML = '<span class="pulsing-text">AI Cluster Processing...</span>';
            } 
            catch(e) { 
                console.error(e);
                document.getElementById('resultText').innerText = "Consult Error."; 
            }
        };
    };
</script>
</body>
</html>

