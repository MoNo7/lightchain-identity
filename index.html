<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI Identity Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 800px; margin: auto; background: #f0f2f5; color: #1c1e21; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 25px; border: 1px solid #e1e4e8; }
        .header { text-align: center; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 40px 20px; border-radius: 15px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
        button { background: #007bff; color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: 600; font-size: 1rem; transition: 0.3s; margin-top: 10px; }
        button:hover { background: #0056b3; transform: translateY(-2px); }
        .status-text { font-size: 0.9rem; margin-top: 15px; opacity: 0.9; display: block; font-weight: bold; }
        .verified-badge { color: #1877F2; font-weight: bold; }
        .checkmark { background: #1877F2; color: white; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 5px; }
        #adminPanel { border: 2px solid #dc3545; display: none; }
        .member-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .member-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div class="card header">
        <h1 style="margin:0; font-size: 2.2rem;">Lightchain Identity Portal</h1>
        <p style="margin: 10px 0 20px;">Secure On-Chain Identity on Lightchain AI Testnet</p>
        <div id="walletActions">
            <button id="connectBtn" style="background: white; color: #007bff; max-width: 250px; margin: auto;">Connect MetaMask</button>
            <button id="disconnectBtn" style="display:none; background: #6c757d; color: white; max-width: 200px; margin: 10px auto;">Disconnect Wallet</button>
        </div>
        <button id="switchNetBtn" style="display:none; background: #ffc107; color: #000; max-width: 250px; margin: 10px auto;">Switch to Lightchain</button>
        <span id="walletStatus" class="status-text">Status: Disconnected</span>
    </div>

    <div class="card">
        <h3 style="margin-top:0;">Global Identity Lookup</h3>
        <div style="display:flex; gap: 10px;">
            <input type="text" id="searchAddr" placeholder="Search by Wallet Address (0x...)">
            <button id="searchBtn" style="width: 120px; margin-top: 10px; background: #6c757d;">Search</button>
        </div>
        <div id="searchResult" style="display:none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <p style="margin:0;"><strong>User:</strong> <span id="resName"></span> <span id="resStatus"></span></p>
        </div>
    </div>

    <div class="card">
        <h3 style="margin-top:0;">Register Your Identity</h3>
        <input type="text" id="regName" placeholder="Desired Username">
        <input type="text" id="regDID" placeholder="DID or Profile Link">
        <button id="createBtn" style="background: #28a745;">Register Identity</button>
    </div>

    <div class="card" id="adminPanel">
        <h3 style="margin-top:0; color: #dc3545;">Admin Control Center</h3>
        <p>Logged in as Admin. Manage the registry below.</p>
        
        <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
            <h4>Verify User</h4>
            <input type="text" id="verifyAddr" placeholder="User Address to Verify (0x...)">
            <button id="verifyBtn" style="background: #dc3545;">Issue Verification</button>
        </div>

        <h4>Recent Registrations</h4>
        <div id="memberList" style="max-height: 200px; overflow-y: auto; background: #fff5f5; border-radius: 8px; padding: 10px;">
            <p style="color: #666; font-style: italic; text-align: center;">Scanning blockchain for members...</p>
        </div>
    </div>

    <script>
        const RAW_CONTRACT = "0xe0087e581f11b9de0d61697a0cb0cdffca8f1f34";
        const LIGHTCHAIN_SETUP = {
            chainId: '0x1f8', 
            chainName: 'Lightchain AI Testnet',
            nativeCurrency: { name: 'LCAI', symbol: 'LCAI', decimals: 18 },
            rpcUrls: ['https://light-testnet-rpc.lightchain.ai'],
            blockExplorerUrls: ['https://testnet-explorer.lightchain.ai']
        };

        const ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"newAdmin","type":"address"}],"name":"AdminAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldAdmin","type":"address"}],"name":"AdminRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"userAddress","type":"address"},{"indexed":false,"internalType":"string","name":"username","type":"string"},{"indexed":false,"internalType":"string","name":"did","type":"string"}],"name":"IdentityCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"userAddress","type":"address"}],"name":"IdentityVerified","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"userAddress","type":"address"}],"name":"VerificationRevoked","type":"event"},{"inputs":[{"internalType":"address","name":"_newAdmin","type":"address"}],"name":"addAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_username","type":"string"},{"internalType":"string","name":"_did","type":"string"}],"name":"createIdentity","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"getIdentity","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isAdmin","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"profiles","outputs":[{"internalType":"string","name":"username","type":"string"},{"internalType":"string","name":"did","type":"string"},{"internalType":"bool","name":"isVerified","type":"bool"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_admin","type":"address"}],"name":"removeAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"revokeVerification","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_userAddress","type":"address"}],"name":"verifyIdentity","outputs":[],"stateMutability":"nonpayable","type":"function"}];

        let signer, contract, provider;

        async function connectWallet() {
            if (!window.ethereum) return alert("MetaMask not detected!");
            try {
                const CONTRACT_ADDRESS = ethers.getAddress(RAW_CONTRACT);
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.BrowserProvider(window.ethereum);
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });

                if (chainId !== LIGHTCHAIN_SETUP.chainId) {
                    document.getElementById('switchNetBtn').style.display = 'block';
                    document.getElementById('walletStatus').innerText = "Status: Switch to Testnet";
                    return;
                }

                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

                const userAddr = accounts[0];
                document.getElementById('walletStatus').innerText = "Status: Connected (" + userAddr.substring(0,6) + "...)";
                document.getElementById('walletStatus').style.color = "#4ade80";
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                document.getElementById('switchNetBtn').style.display = 'none';

                const adminStatus = await contract.isAdmin(userAddr);
                if(adminStatus) {
                    document.getElementById('adminPanel').style.display = 'block';
                    loadMemberList();
                }

            } catch (err) { alert("Connection failed: " + err.message); }
        }

        async function loadMemberList() {
            const listDiv = document.getElementById('memberList');
            try {
                // Fetch 'IdentityCreated' events from the last 10,000 blocks
                const filter = contract.filters.IdentityCreated();
                const events = await contract.queryFilter(filter, -10000);
                
                if (events.length === 0) {
                    listDiv.innerHTML = "<p>No members registered yet.</p>";
                    return;
                }

                listDiv.innerHTML = "";
                events.forEach(event => {
                    const addr = event.args[0];
                    const name = event.args[1];
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.innerHTML = `
                        <span><strong>${name}</strong> (${addr.substring(0,6)}...)</span>
                        <button onclick="document.getElementById('verifyAddr').value='${addr}'" style="width: auto; padding: 5px 10px; font-size: 0.8rem; margin: 0;">Select</button>
                    `;
                    listDiv.appendChild(item);
                });
            } catch (e) { console.error(e); }
        }

        async function disconnect() {
            signer = null; contract = null;
            document.getElementById('walletStatus').innerText = "Status: Disconnected";
            document.getElementById('walletStatus').style.color = "white";
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
        }

        document.getElementById('searchBtn').onclick = async () => {
            const addr = document.getElementById('searchAddr').value;
            if (!ethers.isAddress(addr) || !contract) return alert("Connect and enter valid address.");
            try {
                const p = await contract.getIdentity(addr);
                document.getElementById('searchResult').style.display = 'block';
                document.getElementById('resName').innerText = p[0];
                document.getElementById('resStatus').innerHTML = p[2] ? '<span class="verified-badge">âœ“ Verified</span>' : '(Pending)';
            } catch (e) { alert("Not found"); }
        };

        document.getElementById('verifyBtn').onclick = async () => {
            const addr = document.getElementById('verifyAddr').value;
            if (!ethers.isAddress(addr)) return alert("Invalid Address");
            try {
                const tx = await contract.verifyIdentity(addr);
                alert("Verification transaction sent! Waiting for block...");
                await tx.wait();
                alert("Identity Successfully Verified!");
                loadMemberList();
            } catch (e) { alert("Error: Verify failed. Only admins can verify others."); }
        };

        document.getElementById('createBtn').onclick = async () => {
            const n = document.getElementById('regName').value;
            const d = document.getElementById('regDID').value;
            if(!contract) return alert("Connect Wallet First");
            try {
                const tx = await contract.createIdentity(n, d);
                await tx.wait();
                alert("Identity Registered!");
                location.reload();
            } catch (e) { alert("Already registered or transaction failed."); }
        };

        document.getElementById('connectBtn').onclick = connectWallet;
        document.getElementById('disconnectBtn').onclick = disconnect;
        document.getElementById('switchNetBtn').onclick = () => window.location.reload();
    </script>
</body>
</html>
