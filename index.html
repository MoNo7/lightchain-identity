<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lightchain AI | IAM Control Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --accent: #0070ff; --bg: #020408; --panel: #0b0e14; --border: #1e2633; --text-dim: #6a768a; --console-bg: #05070a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Inter', sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        nav { width: 280px; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 25px; background: var(--panel); box-sizing: border-box; }
        .nav-logo { font-weight: 900; letter-spacing: 2px; color: var(--accent); margin-bottom: 25px; font-size: 1.1rem; text-align: center; height: 30px; }
        
        /* Console Alignment: 80px (Header height) - 25px (Nav padding) - 30px (Logo height) - 25px (Logo margin) = Offset */
        .system-console { 
            background: var(--console-bg); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 12px; 
            font-family: 'IBM Plex Mono', monospace; 
            font-size: 0.65rem; 
            height: 180px; 
            overflow-y: auto; 
            margin-bottom: 20px; 
            color: #4e5d75; 
            line-height: 1.5;
            margin-top: 0px; /* Aligned to perfectly hit the 80px header line */
        }
        .console-line { margin-bottom: 4px; border-left: 2px solid #1a202c; padding-left: 8px; word-wrap: break-word; }
        .console-line.success { border-left-color: var(--accent); color: #fff; }
        
        .nav-menu { display: none; flex-direction: column; gap: 5px; }
        .nav-link { color: var(--text-dim); padding: 12px 15px; cursor: pointer; border-radius: 6px; transition: 0.2s; border: none; background: none; text-align: left; font-size: 0.75rem; font-family: monospace; font-weight: 600; width: 100%; }
        .nav-link:hover, .nav-link.active { color: white; background: var(--accent); }

        /* VIEWPORT */
        .viewport { flex: 1; display: flex; flex-direction: column; }
        header { height: 80px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-sizing: border-box; }
        .tickers { display: flex; gap: 25px; font-family: 'IBM Plex Mono', monospace; font-size: 0.75rem; position: absolute; left: 50%; transform: translateX(-50%); }
        .ticker-item span { color: var(--accent); font-weight: bold; margin-right: 5px; }
        
        .header-right { display: flex; align-items: center; gap: 15px; margin-left: auto; }
        .pill { display: flex; align-items: center; background: #000; border: 1px solid var(--border); border-radius: 50px; padding: 7px 20px; font-size: 0.7rem; color: var(--accent); font-family: monospace; }
        .wallet-pill { background: var(--accent); color: white; border-radius: 50px; padding: 9px 24px; font-weight: 900; cursor: pointer; border: none; font-size: 0.75rem; }

        .view-pane { flex: 1; padding: 45px; display: none; overflow-y: auto; }
        .view-pane.connected { display: block !important; }

        .card { background: var(--panel); border: 1px solid var(--border); padding: 35px; border-radius: 12px; max-width: 700px; border-top: 4px solid var(--accent); margin-bottom: 20px; }
        .panel-input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; font-size: 0.7rem; margin-bottom: 12px; box-sizing: border-box; }
        .action-btn { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 4px; font-size: 0.65rem; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 8px; }
        .action-btn.alt { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        
        pre { background: var(--console-bg); padding: 20px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.75rem; color: var(--text-dim); margin: 20px 0; white-space: pre-wrap; word-break: break-all; }
        #qr-target { background: white; padding: 12px; display: inline-block; border-radius: 8px; margin-top: 20px; cursor: pointer; }

        /* GALLERY & PAGINATION */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; margin-top: 20px; min-height: 300px; }
        .gallery-item { background: #000; border: 1px solid var(--border); border-radius: 6px; padding: 8px; text-align: center; }
        .gallery-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; background: #111; margin-bottom: 5px; opacity: 0.8; }
        .gallery-item .prompt { font-size: 0.55rem; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .pagination-ctrl { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 25px; font-family: monospace; font-size: 0.7rem; }
        .pg-btn { background: var(--border); color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; }
        .pg-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .art-preview { width: 100%; height: 250px; background: #000; border: 1px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-dim); font-size: 0.8rem; margin-bottom: 15px; overflow: hidden; }
    </style>
</head>
<body>

<nav>
    <div class="nav-logo">LCAI <span>IAM</span></div>
    <div class="system-console" id="console">
        <div class="console-line">>> INITIALIZING LCAI_IAM_CORE...</div>
        <div class="console-line">>> STATUS: DISCONNECTED</div>
    </div>
    <div class="nav-menu" id="side-menu">
        <button class="nav-link active" onclick="showView('id-view', this)">ZK IDENTITY</button>
        <button class="nav-link" onclick="showView('recovery-view', this)">IDENTITY RECOVERY</button>
        <button class="nav-link" onclick="showView('aivm-view', this)">LCAI AIVM ART</button>
        <button class="nav-link" onclick="showView('gallery-view', this); initGallery();">NETWORK GALLERY</button>
    </div>
</nav>

<div class="viewport">
    <header>
        <div style="flex:1"></div>
        <div class="tickers">
            <div class="ticker-item"><span>ETH:</span> <div id="eth-price">$---</div></div>
            <div class="ticker-item"><span>LCAI:</span> <div id="lcai-price">$---</div></div>
        </div>
        <div class="header-right">
            <div class="pill">AIVM-THETA | <span id="load-num">0%</span> | <span id="status-txt">IDLE</span></div>
            <button id="wallet-btn" class="wallet-pill" onclick="connectWallet()">CONNECT WALLET</button>
        </div>
    </header>

    <div id="id-view" class="view-pane">
        <div class="card">
            <h2>ZK-SBT IDENTITY</h2>
            <pre id="id-json">{ "auth": "pending_wallet_connection" }</pre>
            <button onclick="saveJSON()" class="action-btn alt" style="width: auto; padding: 10px 25px;">DOWNLOAD JSON</button>
            <br><br>
            <div id="qr-target" onclick="saveQR()"></div>
        </div>
    </div>

    <div id="recovery-view" class="view-pane">
        <div class="card">
            <h2>IDENTITY RECOVERY</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px;">
                <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 20px; border-radius: 8px;">
                    <h4 style="color:var(--accent); margin-top:0;">ADMIN</h4>
                    <input type="text" class="panel-input" placeholder="User Address" id="admin-addr">
                    <button class="action-btn" onclick="runAdmin('queryStatus')">QUERY STATUS</button>
                    <button class="action-btn" onclick="runAdmin('setVerification', true)">VERIFY</button>
                    <button class="action-btn alt" style="border-color:#ff4444; color:#ff4444;" onclick="runAdmin('setVerification', false)">REVOKE</button>
                </div>
                <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 20px; border-radius: 8px;">
                    <h4 style="color:var(--accent); margin-top:0;">OWNER</h4>
                    <div style="background:#000; padding:12px; border-radius:4px; margin-bottom:12px; border:1px solid var(--border);">
                        <div style="font-size:0.6rem; color:var(--text-dim);">VAULT</div>
                        <div style="font-size:1.1rem; font-weight:bold;" id="revenue-val">0.00 ETH</div>
                    </div>
                    <button class="action-btn" onclick="runOwner('withdraw')">WITHDRAW</button>
                </div>
            </div>
        </div>
    </div>

    <div id="aivm-view" class="view-pane">
        <div class="card">
            <h2>LCAI AIVM INFERENCE</h2>
            <div class="art-preview" id="art-preview-box">[ AIVM RENDER TARGET ]</div>
            <textarea id="art-prompt" class="panel-input" placeholder="Neural synthwave landscape..." style="height: 80px;"></textarea>
            <button class="action-btn" onclick="generateArt()">REQUEST INFERENCE</button>
        </div>
    </div>

    <div id="gallery-view" class="view-pane">
        <div class="card" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>NETWORK GALLERY</h2>
                <button class="action-btn alt" style="width: auto; padding: 5px 15px;" onclick="initGallery()">REFRESH SCAN</button>
            </div>
            <div class="gallery-grid" id="gallery-grid"></div>
            <div class="pagination-ctrl">
                <button class="pg-btn" id="pg-prev" onclick="changePage(-1)" disabled>PREV</button>
                <span id="pg-info">PAGE 1 OF 1</span>
                <button class="pg-btn" id="pg-next" onclick="changePage(1)" disabled>NEXT</button>
            </div>
        </div>
    </div>
</div>

<script>
const CONFIG = {
    addr: "0xbcA38515887Dc3Ca163398C0Ef7bF02dd156D8FB",
    abi: [
        "function setVerification(address user, bool status) external",
        "function withdraw() external",
        "function manualVerified(address) public view returns (bool)",
        "function owner() public view returns (address)",
        "function transferOwnership(address newOwner) public",
        "function requestInference(string prompt) external payable",
        "event InferenceRequested(address indexed user, string prompt)"
    ]
};

let user, provider, signer, contract;
let allArtEvents = [];
let currentPage = 1;
const pageSize = 8;

const log = (msg, ok = false) => {
    const l = document.createElement('div');
    l.className = `console-line ${ok ? 'success' : ''}`;
    l.innerText = `>> ${msg}`;
    const cb = document.getElementById('console');
    cb.appendChild(l);
    cb.scrollTop = cb.scrollHeight;
};

// Tickers
async function syncTickers() {
    try {
        const ethR = await fetch('https://min-api.cryptocompare.com/data/price?fsym=ETH&tsyms=USD');
        const ethD = await ethR.json();
        document.getElementById('eth-price').innerText = `$${ethD.USD.toLocaleString()}`;
        const lcaiR = await fetch('https://api.coingecko.com/api/v3/simple/token_price/ethereum?contract_addresses=0x9ca8530ca349c966fe9ef903df17a75b8a778927&vs_currencies=usd');
        const lcaiD = await lcaiR.json();
        const price = lcaiD["0x9ca8530ca349c966fe9ef903df17a75b8a778927"].usd;
        document.getElementById('lcai-price').innerText = `$${price.toFixed(5)}`;
    } catch(e) { document.getElementById('lcai-price').innerText = "$0.00195"; }
}
setInterval(syncTickers, 5000); syncTickers();

// Admin Functions
async function runAdmin(method, status = null) {
    if(!contract) return log("ERR: WALLET NOT CONNECTED");
    const target = document.getElementById('admin-addr').value || user;
    try {
        if(method === 'queryStatus') {
            log(`QUERYING: ${target.slice(0,10)}...`);
            const isVerified = await contract.manualVerified(target);
            log(`STATUS: ${isVerified ? "VERIFIED" : "UNVERIFIED"}`, isVerified);
        } else {
            log(`ACTION: ${method}...`);
            const tx = await contract.setVerification(target, status);
            log("TX PENDING...");
            await tx.wait();
            log("SUCCESS: IDENTITY UPDATED", true);
        }
    } catch(e) { log(`ERR: ${e.reason || "AUTH_FAIL"}`); }
}

async function runOwner(m) {
    if(!contract) return;
    try {
        log(`OWNER: WITHDRAWING FUNDS...`);
        const tx = await contract.withdraw();
        await tx.wait();
        log("WITHDRAWAL COMPLETE", true);
        refreshBalance();
    } catch(e) { log(`ERR: ${e.reason || "DENIED"}`); }
}

async function refreshBalance() {
    try {
        const bal = await provider.getBalance(CONFIG.addr);
        document.getElementById('revenue-val').innerText = `${ethers.formatEther(bal).slice(0,6)} ETH`;
    } catch(e) {}
}

// AIVM Inference Fix
async function generateArt() {
    if(!contract) return log("ERR: CONNECT WALLET");
    const prompt = document.getElementById('art-prompt').value;
    if(!prompt) return log("ERR: PROMPT EMPTY");
    try {
        log(`AIVM: PREPARING INFERENCE TX...`);
        
        // Fix: Pass {value: ...} because the contract function is payable.
        // If this value is incorrect, change "0.001" to match your contract's exact fee.
        const options = { value: ethers.parseEther("0.001") }; 
        const tx = await contract.requestInference(prompt, options);
        
        log("TX SUBMITTED, AWAITING CONFIRMATION...");
        await tx.wait();
        
        log("INFERENCE SUCCESSFUL", true);
        document.getElementById('art-preview-box').innerHTML = `<img src="https://picsum.photos/seed/${Date.now()}/600/250" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">`;
        initGallery(); // Refresh gallery
    } catch(e) { 
        console.error(e); // Logs full error to Chrome DevTools for deeper inspection
        log(`ERR: ${e.reason || "TX REJECTED/REVERTED"}`); 
    }
}

// Gallery & Pagination
async function initGallery() {
    if(!contract) return;
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = `<div style="color:var(--accent);">SCANNING BLOCKCHAIN...</div>`;
    try {
        log("GALLERY: FETCHING HISTORICAL LOGS...");
        const filter = contract.filters.InferenceRequested();
        allArtEvents = await contract.queryFilter(filter, 0); 
        allArtEvents.reverse(); 
        
        log(`SCAN COMPLETE: ${allArtEvents.length} ITEMS FOUND`, true);
        currentPage = 1;
        renderGalleryPage();
    } catch(e) { log("ERR: SCAN FAILED"); grid.innerHTML = "Scan error. Check network."; }
}

function renderGalleryPage() {
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = "";
    
    if(allArtEvents.length === 0) {
        grid.innerHTML = "No requests found.";
        return;
    }

    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageItems = allArtEvents.slice(start, end);
    const totalPages = Math.ceil(allArtEvents.length / pageSize);

    pageItems.forEach(ev => {
        const p = ev.args[1] || "AIVM Art";
        grid.innerHTML += `
            <div class="gallery-item">
                <img src="https://picsum.photos/seed/${ev.transactionHash}/150/120" loading="lazy">
                <div class="prompt" title="${p}">${p}</div>
                <div class="prompt" style="color:var(--accent); font-weight:bold;">${ev.args[0].slice(0,6)}...</div>
            </div>`;
    });

    document.getElementById('pg-info').innerText = `PAGE ${currentPage} OF ${totalPages}`;
    document.getElementById('pg-prev').disabled = currentPage === 1;
    document.getElementById('pg-next').disabled = currentPage >= totalPages;
}

function changePage(dir) {
    currentPage += dir;
    renderGalleryPage();
}

// Connection & Wallet
async function connectWallet() {
    if(!window.ethereum) return log("ERR: NO WALLET");
    try {
        provider = new ethers.BrowserProvider(window.ethereum);
        const accs = await provider.send("eth_requestAccounts", []);
        user = accs[0];
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONFIG.addr, CONFIG.abi, signer);
        
        document.getElementById('wallet-btn').innerText = user.slice(0,6).toUpperCase() + "..." + user.slice(-4).toUpperCase();
        log(`CONNECTED: ${user.slice(0,10)}`, true);
        
        document.getElementById('side-menu').style.display = 'flex';
        document.getElementById('id-view').classList.add('connected');
        
        // Full ZK Metadata Restore
        const now = new Date();
        const identityData = {
            "identity": {
                "name": `Operator_${user.slice(2, 6)}`,
                "role": "LCAI_IAM_OPERATOR",
                "access_tier": "Alpha_V1",
                "created_at": now.toISOString(),
                "unix_timestamp": Math.floor(now.getTime() / 1000)
            },
            "on_chain_meta": {
                "address": user,
                "contract": CONFIG.addr,
                "verification": "zk-SNARK_SBT",
                "network": "Lightchain_AIVM_Mainnet"
            },
            "security": {
                "protocol": "IAM_CORE_v2.1",
                "status": "active",
                "hash": "Keccak-256"
            }
        };

        document.getElementById('id-json').innerText = JSON.stringify(identityData, null, 4);
        document.getElementById('qr-target').innerHTML = "";
        new QRCode(document.getElementById("qr-target"), { text: user, width: 140, height: 140 });

        refreshBalance();
    } catch(e) { log("ERR: CONNECTION FAILED"); }
}

function showView(id, btn) {
    document.querySelectorAll('.view-pane').forEach(el => el.classList.remove('connected'));
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('connected');
    btn.classList.add('active');
}

function saveJSON() {
    const b = new Blob([document.getElementById('id-json').innerText], {type:"application/json"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download="id.json"; a.click();
}

function saveQR() {
    const c = document.querySelector('#qr-target canvas');
    if(c) { const a = document.createElement('a'); a.href = c.toDataURL(); a.download="qr.png"; a.click(); }
}
</script>
</body>
</html>
