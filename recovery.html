<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LCAI | Archive Recovery v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { background: #050505; color: #fff; font-family: sans-serif; padding: 40px; }
        .card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .item { background: #000; border: 1px solid #222; padding: 15px; border-radius: 8px; }
        .btn { background: #00d1ff; color: #000; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Historical Art Recovery</h1>
    <div class="card">
        <button id="scanBtn" class="btn">Deep Scan Blockchain</button>
        <p id="status" style="color: #888;">Scanning for InferenceRequested logs...</p>
    </div>
    <div id="results" class="grid"></div>

    <script>
        const ROUTER = "0x0269683E61b210d56b3D692603336fEB27B8a83a";
        const API = "https://chat2.lightchain.ai/api/v1";

        document.getElementById('scanBtn').onclick = async () => {
            const status = document.getElementById('status');
            const results = document.getElementById('results');
            if(!window.ethereum) return;

            status.innerText = "Initializing Scanner...";
            const provider = new ethers.BrowserProvider(window.ethereum);
            const signer = await provider.getSigner();
            const addr = await signer.getAddress();

            try {
                // Topic 0: InferenceRequested hash
                // Topic 2: Your address (indexed)
                const eventSignature = ethers.id("InferenceRequested(bytes32,address,uint256)");
                const filter = {
                    address: ROUTER,
                    fromBlock: 1600000, 
                    toBlock: 'latest',
                    topics: [eventSignature, null, ethers.zeroPadValue(addr, 32)]
                };

                const logs = await provider.getLogs(filter);
                status.innerText = `Found ${logs.length} on-chain records. Checking status...`;

                logs.forEach(async (log) => {
                    const taskId = log.topics[1]; // The TaskID
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `<small>ID: ${taskId.substring(0,15)}...</small><div id="img-${taskId}">Loading...</div>`;
                    results.appendChild(div);

                    // Check API for the image
                    const res = await fetch(`${API}/chat/status?taskId=${taskId}`);
                    const data = await res.json();
                    if(data.ready && data.url) {
                        document.getElementById(`img-${taskId}`).innerHTML = `<img src="${data.url}" style="width:100%;"><br><a href="${data.url}" download style="color:#00d1ff">Download</a>`;
                    } else {
                        document.getElementById(`img-${taskId}`).innerText = "Processing or Expired";
                    }
                });
            } catch (e) { status.innerText = "Scan failed: " + e.message; }
        };
    </script>
</body>
</html>
